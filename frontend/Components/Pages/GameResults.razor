@page "/game-results"
@using SportsBettingAnalyzer.Services
@inject PythonMLServiceClient MLClient
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Game Results</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <div>
            <MudText Typo="Typo.h4" GutterBottom="true">Game Results</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">View player stats by game</MudText>
        </div>
        
        <!-- Sport Toggle -->
        <MudToggleGroup T="string" @bind-Value="_selectedSport" Color="Color.Primary" Outline="true" Size="Size.Large">
            <MudToggleItem Value="@("nfl")">
                <MudIcon Icon="@Icons.Material.Filled.SportsFootball" Class="mr-1" /> NFL
            </MudToggleItem>
            <MudToggleItem Value="@("nba")">
                <MudIcon Icon="@Icons.Material.Filled.SportsBasketball" Class="mr-1" /> NBA
            </MudToggleItem>
        </MudToggleGroup>
    </div>
    
    <!-- Filters -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudSelect T="int?" @bind-Value="_selectedSeason" Label="Season" Clearable="true" Variant="Variant.Outlined" Dense="true">
                    @foreach (var season in _seasons)
                    {
                        <MudSelectItem Value="@((int?)season)">@season</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudTextField @bind-Value="_searchPlayer" Label="Player Search" Variant="Variant.Outlined" Dense="true"
                              Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                              DebounceInterval="500" OnDebounceIntervalElapsed="LoadResults" />
            </MudItem>
            @if (_selectedSport == "nfl")
            {
                <MudItem xs="12" md="2">
                    <MudSelect T="int?" @bind-Value="_selectedWeek" Label="Week" Clearable="true" Variant="Variant.Outlined" Dense="true">
                        @for (int w = 1; w <= 18; w++)
                        {
                            <MudSelectItem Value="@((int?)w)">Week @w</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            }
            <MudItem xs="12" md="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="LoadResults"
                           StartIcon="@Icons.Material.Filled.Refresh" Disabled="@_isLoading">
                    Search
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>
    
    <!-- Results Table -->
    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }
    
    <MudPaper Elevation="2" Class="pa-4">
        <MudTable Items="@_results" Dense="true" Hover="true" Striped="true" Loading="@_isLoading"
                  LoadingProgressColor="Color.Primary">
            <HeaderContent>
                <MudTh>Season</MudTh>
                @if (_selectedSport == "nfl")
                {
                    <MudTh>Week</MudTh>
                    <MudTh>Player</MudTh>
                    <MudTh>Pos</MudTh>
                    <MudTh>Pass Yds</MudTh>
                    <MudTh>Rush Yds</MudTh>
                    <MudTh>Rec Yds</MudTh>
                    <MudTh>TDs</MudTh>
                }
                else
                {
                    <MudTh>Date</MudTh>
                    <MudTh>Player</MudTh>
                    <MudTh>OPP</MudTh>
                    <MudTh>PTS</MudTh>
                    <MudTh>REB</MudTh>
                    <MudTh>AST</MudTh>
                    <MudTh>STL</MudTh>
                    <MudTh>BLK</MudTh>
                }
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Season</MudTd>
                @if (_selectedSport == "nfl")
                {
                    <MudTd>@context.Week</MudTd>
                    <MudTd>
                        <MudLink Href="@($"/player-profiles?sport=nfl&player={Uri.EscapeDataString(context.PlayerName ?? "")}")" Color="Color.Primary">
                            @context.PlayerName
                        </MudLink>
                    </MudTd>
                    <MudTd>@context.Position</MudTd>
                    <MudTd>@context.PassYds</MudTd>
                    <MudTd>@context.RushYds</MudTd>
                    <MudTd>@context.RecYds</MudTd>
                    <MudTd>@(context.PassTd + context.RushTd + context.RecTd)</MudTd>
                }
                else
                {
                    <MudTd>@context.GameDate</MudTd>
                    <MudTd>
                        <MudLink Href="@($"/player-profiles?sport=nba&player={Uri.EscapeDataString(context.PlayerName ?? "")}")" Color="Color.Primary">
                            @context.PlayerName
                        </MudLink>
                    </MudTd>
                    <MudTd>@context.Opponent</MudTd>
                    <MudTd><strong>@context.Pts</strong></MudTd>
                    <MudTd>@context.Reb</MudTd>
                    <MudTd>@context.Ast</MudTd>
                    <MudTd>@context.Stl</MudTd>
                    <MudTd>@context.Blk</MudTd>
                }
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No results found. Try adjusting your filters.</MudText>
            </NoRecordsContent>
        </MudTable>
        
        <!-- Pagination -->
        <div class="d-flex justify-center mt-4">
            <MudPagination Count="@_totalPages" @bind-Selected="_currentPage" Color="Color.Primary" ShowFirstButton="true" ShowLastButton="true" />
        </div>
    </MudPaper>
</MudContainer>

@code {
    private string _selectedSport = "nfl";
    private int? _selectedSeason;
    private int? _selectedWeek;
    private string? _searchPlayer;
    private bool _isLoading = false;
    
    private List<int> _seasons = new();
    private List<GameResult> _results = new();
    private int _currentPage = 1;
    private int _totalPages = 1;
    private const int PageSize = 50;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadSeasons();
        await LoadResults();
    }
    
    protected override async Task OnParametersSetAsync()
    {
        // Read query params from URL
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        if (!string.IsNullOrEmpty(query["sport"]))
        {
            _selectedSport = query["sport"]!;
        }
        if (!string.IsNullOrEmpty(query["player"]))
        {
            _searchPlayer = query["player"];
        }
        if (int.TryParse(query["season"], out var season))
        {
            _selectedSeason = season;
        }
    }
    
    private async Task LoadSeasons()
    {
        try
        {
            var response = await MLClient.HttpClient.GetAsync($"/db/games/{_selectedSport}/seasons");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var data = System.Text.Json.JsonSerializer.Deserialize<SeasonsResponse>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                _seasons = data?.Seasons ?? new List<int>();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading seasons: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task LoadResults()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();
            
            var url = $"/db/games/{_selectedSport}/list?limit={PageSize}";
            if (_selectedSeason.HasValue)
                url += $"&season={_selectedSeason.Value}";
            if (!string.IsNullOrEmpty(_searchPlayer))
                url += $"&player={Uri.EscapeDataString(_searchPlayer)}";
            if (_selectedWeek.HasValue && _selectedSport == "nfl")
                url += $"&week={_selectedWeek.Value}";
            
            var response = await MLClient.HttpClient.GetAsync(url);
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var data = System.Text.Json.JsonSerializer.Deserialize<GameResultsResponse>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                _results = data?.Results ?? new List<GameResult>();
                _totalPages = Math.Max(1, (data?.Count ?? 0) / PageSize + 1);
            }
            else
            {
                _results = new List<GameResult>();
                Snackbar.Add("Error loading results", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            _results = new List<GameResult>();
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    // Response models
    public class SeasonsResponse
    {
        public List<int> Seasons { get; set; } = new();
    }
    
    public class GameResultsResponse
    {
        public List<GameResult> Results { get; set; } = new();
        public int Count { get; set; }
    }
    
    public class GameResult
    {
        public int Season { get; set; }
        public int? Week { get; set; }
        public string? PlayerName { get; set; }
        public string? Player_Name { get; set; }
        public string? Position { get; set; }
        public string? Opponent { get; set; }
        public string? GameDate { get; set; }
        public string? Game_Date { get; set; }
        
        // NFL stats
        public int? PassYds { get; set; }
        public int? Pass_Yds { get; set; }
        public int? RushYds { get; set; }
        public int? Rush_Yds { get; set; }
        public int? RecYds { get; set; }
        public int? Rec_Yds { get; set; }
        public int? PassTd { get; set; }
        public int? Pass_Td { get; set; }
        public int? RushTd { get; set; }
        public int? Rush_Td { get; set; }
        public int? RecTd { get; set; }
        public int? Rec_Td { get; set; }
        
        // NBA stats
        public int? Pts { get; set; }
        public int? Reb { get; set; }
        public int? Ast { get; set; }
        public int? Stl { get; set; }
        public int? Blk { get; set; }
        
        // Property accessors for snake_case variations
        public string? GetPlayerName() => PlayerName ?? Player_Name;
        public string? GetGameDate() => GameDate ?? Game_Date;
    }
}
