@page "/power-rankings"
@rendermode InteractiveServer
@using MudBlazor
@inject HttpClient Http
@inject ISnackbar Snackbar

<PageTitle>Power Rankings - Sports Betting Analyzer</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Warning" Class="mr-2" />
        Power Rankings
    </MudText>

    <!-- Controls -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudStack Row="true" Spacing="4" AlignItems="AlignItems.Center">
            <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined">
                <MudButton Variant="@(_selectedSport == "nfl" ? Variant.Filled : Variant.Outlined)"
                           OnClick="@(() => SelectSport("nfl"))">NFL</MudButton>
                <MudButton Variant="@(_selectedSport == "nba" ? Variant.Filled : Variant.Outlined)"
                           OnClick="@(() => SelectSport("nba"))">NBA</MudButton>
                <MudButton Variant="@(_selectedSport == "nascar" ? Variant.Filled : Variant.Outlined)"
                           OnClick="@(() => SelectSport("nascar"))">NASCAR</MudButton>
            </MudButtonGroup>
            
            <MudNumericField T="int" @bind-Value="_season" Label="Season" Min="2015" Max="2030"
                             Variant="Variant.Outlined" Dense="true" Style="width: 120px;" />
            
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadRankings"
                       Disabled="@_isLoading">
                @if (_isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Generate
            </MudButton>
        </MudStack>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else if (_rankings.Count > 0)
    {
        <!-- Tier Legend -->
        <MudStack Row="true" Justify="Justify.Center" Spacing="4" Class="mb-4">
            <MudChip T="string" Color="Color.Warning" Size="Size.Small">‚≠ê Elite</MudChip>
            <MudChip T="string" Color="Color.Info" Size="Size.Small">üîµ Contender</MudChip>
            <MudChip T="string" Color="Color.Default" Size="Size.Small">‚ö™ Middle</MudChip>
            <MudChip T="string" Color="Color.Error" Size="Size.Small">üî¥ Rebuilding</MudChip>
        </MudStack>

        <!-- Rankings List -->
        <MudPaper Class="pa-4" Elevation="2">
            @foreach (var team in _rankings)
            {
                <MudPaper Class="pa-3 mb-2" Elevation="1" Style="@GetRowStyle(team.Tier)">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <MudText Typo="Typo.h5" Style="@($"{GetRankStyle(team.Rank)} width: 40px;")">
                                @team.Rank
                            </MudText>
                            <div>
                                <MudText Typo="Typo.subtitle1"><strong>@team.Team</strong></MudText>
                                <MudText Typo="Typo.caption">@team.Record</MudText>
                            </div>
                        </MudStack>
                        
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
                            <div style="text-align: center;">
                                <MudText Typo="Typo.h6">@team.PowerScore</MudText>
                                <MudText Typo="Typo.caption">Power</MudText>
                            </div>
                            <MudChip T="string" Color="@GetTierColor(team.Tier)" Size="Size.Small">
                                @team.Tier
                            </MudChip>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            }
        </MudPaper>
        
        <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Secondary">
            @_rankings.Count teams ranked
        </MudText>
    }
    else
    {
        <MudAlert Severity="Severity.Info">
            Click "Generate" to calculate power rankings for @_selectedSport.ToUpper() @_season.
        </MudAlert>
    }
</MudContainer>

@code {
    private string _selectedSport = "nfl";
    private int _season = DateTime.Now.Year;
    private bool _isLoading = false;
    private List<RankingEntry> _rankings = new();

    private async Task SelectSport(string sport)
    {
        _selectedSport = sport;
        _rankings.Clear();
        StateHasChanged();
    }

    private async Task LoadRankings()
    {
        _isLoading = true;
        _rankings.Clear();
        StateHasChanged();
        
        try
        {
            var url = $"http://localhost:8000/rankings/{_selectedSport}?season={_season}";
            var response = await Http.GetFromJsonAsync<RankingsResponse>(url);
            
            if (response?.Rankings != null)
            {
                _rankings = response.Rankings;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private string GetRankStyle(int rank) => rank switch
    {
        1 => "color: gold;",
        2 => "color: silver;",
        3 => "color: #cd7f32;",
        _ => ""
    };

    private string GetRowStyle(string tier) => tier switch
    {
        "Elite" => "border-left: 4px solid #ffc107;",
        "Contender" => "border-left: 4px solid #2196f3;",
        "Rebuilding" => "border-left: 4px solid #f44336;",
        _ => "border-left: 4px solid #9e9e9e;"
    };

    private Color GetTierColor(string tier) => tier switch
    {
        "Elite" => Color.Warning,
        "Contender" => Color.Info,
        "Middle" => Color.Default,
        "Rebuilding" => Color.Error,
        _ => Color.Default
    };

    public class RankingsResponse
    {
        public List<RankingEntry> Rankings { get; set; } = new();
    }

    public class RankingEntry
    {
        public int Rank { get; set; }
        public string Team { get; set; } = "";
        public double PowerScore { get; set; }
        public string Record { get; set; } = "";
        public string Tier { get; set; } = "";
    }
}
