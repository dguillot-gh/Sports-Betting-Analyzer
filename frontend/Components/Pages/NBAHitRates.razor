@page "/nba-hit-rates"
@using SportsBettingAnalyzer.Services
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>NBA Hit Rates</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <div>
            <MudText Typo="Typo.h4" GutterBottom="true">
                <MudIcon Icon="@Icons.Material.Filled.SportsBasketball" Class="mr-2" />
                NBA Hit Rates
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Prop bet analysis - Find consistent NBA performers</MudText>
        </div>
    </div>
    
    <!-- Search and Filters -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="2">
                <MudSelect T="int" @bind-Value="_selectedSeason" Label="Season" Variant="Variant.Outlined" Dense="true">
                    @foreach (var season in _availableSeasons)
                    {
                        <MudSelectItem Value="@season">@season</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudTextField @bind-Value="_searchPlayer" Label="Player Search" Variant="Variant.Outlined" Dense="true"
                              Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                              Placeholder="LeBron James, Shai Gilgeous-Alexander..."
                              DebounceInterval="500" OnDebounceIntervalElapsed="SearchPlayers" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudSelect T="string" Value="_selectedStat" ValueChanged="OnStatChanged" Label="Stat Type" Variant="Variant.Outlined" Dense="true">
                    <MudSelectItem Value="@("pts")">Points</MudSelectItem>
                    <MudSelectItem Value="@("reb")">Rebounds</MudSelectItem>
                    <MudSelectItem Value="@("ast")">Assists</MudSelectItem>
                    <MudSelectItem Value="@("fg3")">3-Pointers Made</MudSelectItem>
                    <MudSelectItem Value="@("stl")">Steals</MudSelectItem>
                    <MudSelectItem Value="@("blk")">Blocks</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="2">
                <MudNumericField T="int" @bind-Value="_threshold" Label="Over Line" Variant="Variant.Outlined" Dense="true"
                                 Min="0" Max="100" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="CalculateHitRates"
                           StartIcon="@Icons.Material.Filled.Calculate" Disabled="@_isLoading">
                    Calculate
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>
    
    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }
    
    @if (_hitRates.Any())
    {
        <!-- Summary Cards -->
        <MudGrid Class="mb-4">
            @foreach (var player in _hitRates.Take(3))
            {
                <MudItem xs="12" md="4">
                    <MudCard Elevation="3" Style="@GetCardStyle(player.SeasonRate)">
                        <MudCardContent>
                            <div class="d-flex justify-space-between align-center">
                                <div>
                                    <MudText Typo="Typo.h6">@player.PlayerName</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        Over @_threshold @GetStatLabel(_selectedStat) (@_selectedSeason)
                                    </MudText>
                                </div>
                                <MudAvatar Color="@GetRateColor(player.SeasonRate)" Size="Size.Large">
                                    @player.SeasonRate.ToString("P0")
                                </MudAvatar>
                            </div>
                            <MudDivider Class="my-3" />
                            <div class="d-flex justify-space-around">
                                <div class="text-center">
                                    <MudText Typo="Typo.h5" Color="@GetRateColor(player.Last5Rate)">
                                        @player.Last5Hits/@player.Last5Games
                                    </MudText>
                                    <MudText Typo="Typo.caption">Last 5</MudText>
                                </div>
                                <div class="text-center">
                                    <MudText Typo="Typo.h5" Color="@GetRateColor(player.Last10Rate)">
                                        @player.Last10Hits/@player.Last10Games
                                    </MudText>
                                    <MudText Typo="Typo.caption">Last 10</MudText>
                                </div>
                                <div class="text-center">
                                    <MudText Typo="Typo.h5" Color="@GetRateColor(player.SeasonRate)">
                                        @player.SeasonHits/@player.SeasonGames
                                    </MudText>
                                    <MudText Typo="Typo.caption">Season</MudText>
                                </div>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
        
        <!-- Full Table -->
        <MudPaper Elevation="2" Class="pa-4">
            <MudTable Items="@_hitRates" Dense="true" Hover="true" Striped="true">
                <HeaderContent>
                    <MudTh>Player</MudTh>
                    <MudTh>Team</MudTh>
                    <MudTh Style="text-align: center">L5</MudTh>
                    <MudTh Style="text-align: center">L10</MudTh>
                    <MudTh Style="text-align: center">Season</MudTh>
                    <MudTh Style="text-align: center">Avg</MudTh>
                    <MudTh Style="text-align: center">Trend</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudLink Href="@($"/nba-player-profiles?player={Uri.EscapeDataString(context.PlayerName)}")" 
                                 Color="Color.Primary">
                            @context.PlayerName
                        </MudLink>
                    </MudTd>
                    <MudTd>@context.Team</MudTd>
                    <MudTd Style="text-align: center">
                        <MudChip T="string" Color="@GetRateColor(context.Last5Rate)" Size="Size.Small">
                            @context.Last5Hits/@context.Last5Games
                        </MudChip>
                    </MudTd>
                    <MudTd Style="text-align: center">
                        <MudChip T="string" Color="@GetRateColor(context.Last10Rate)" Size="Size.Small">
                            @context.Last10Hits/@context.Last10Games
                        </MudChip>
                    </MudTd>
                    <MudTd Style="text-align: center">
                        <MudChip T="string" Color="@GetRateColor(context.SeasonRate)" Size="Size.Small">
                            @context.SeasonRate.ToString("P0")
                        </MudChip>
                    </MudTd>
                    <MudTd Style="text-align: center">
                        <strong>@context.SeasonAvg.ToString("F1")</strong>
                    </MudTd>
                    <MudTd Style="text-align: center">
                        @if (context.Last5Rate > context.SeasonRate)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Success" />
                        }
                        else if (context.Last5Rate < context.SeasonRate)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.TrendingDown" Color="Color.Error" />
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.TrendingFlat" Color="Color.Default" />
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
            
            <!-- Averages Summary -->
            @if (_hitRates.Any())
            {
                <MudDivider Class="my-3" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Analytics" Size="Size.Small" Class="mr-1" />
                    Season Averages (Selected Players)
                </MudText>
                <MudStack Row="true" Spacing="4" Justify="Justify.SpaceAround">
                    <MudPaper Class="pa-3 text-center" Elevation="1" Style="min-width: 120px;">
                        <MudText Typo="Typo.h5" Color="Color.Primary">@GetOverallAvg("pts").ToString("F1")</MudText>
                        <MudText Typo="Typo.caption">Avg Points</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-3 text-center" Elevation="1" Style="min-width: 120px;">
                        <MudText Typo="Typo.h5" Color="Color.Secondary">@GetOverallAvg("reb").ToString("F1")</MudText>
                        <MudText Typo="Typo.caption">Avg Rebounds</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-3 text-center" Elevation="1" Style="min-width: 120px;">
                        <MudText Typo="Typo.h5" Color="Color.Tertiary">@GetOverallAvg("ast").ToString("F1")</MudText>
                        <MudText Typo="Typo.caption">Avg Assists</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-3 text-center" Elevation="1" Style="min-width: 120px;">
                        <MudText Typo="Typo.h5" Color="Color.Info">@GetOverallAvg("fg3").ToString("F1")</MudText>
                        <MudText Typo="Typo.caption">Avg 3PM</MudText>
                    </MudPaper>
                </MudStack>
            }
        </MudPaper>
    }
    else if (!_isLoading && _searchCompleted)
    {
        <MudAlert Severity="Severity.Info">
            No hit rate data found. Try searching for a player or adjusting filters.
        </MudAlert>
    }
</MudContainer>

@code {
    private string _searchPlayer = "";
    private string _selectedStat = "pts";
    private int _threshold = 20;
    private int _selectedSeason = 2025;
    private bool _isLoading = false;
    private bool _searchCompleted = false;
    
    private List<int> _availableSeasons = new() { 2025, 2024, 2023 };
    private List<HitRateResult> _hitRates = new();
    private List<GameResult> _allGameResults = new(); // For computing multi-stat averages
    
    protected override async Task OnInitializedAsync()
    {
        await LoadSeasons();
    }
    
    private async Task LoadSeasons()
    {
        try
        {
            // Query seasons from the nba_game_log data (not schedules)
            var response = await Http.GetFromJsonAsync<SeasonsResponse>(
                "http://backend:8000/db/games/nba/seasons?series=nba_game_log");
            if (response?.Seasons?.Any() == true)
            {
                _availableSeasons = response.Seasons;
                _selectedSeason = _availableSeasons.First();
            }
        }
        catch { }
    }
    
    private void OnStatChanged(string newStat)
    {
        _selectedStat = newStat;
        // Auto-adjust thresholds based on stat type
        _threshold = newStat switch
        {
            "pts" => 20,
            "reb" => 8,
            "ast" => 6,
            "fg3" => 3,
            "stl" => 2,
            "blk" => 2,
            _ => 10
        };
    }
    
    private async Task SearchPlayers()
    {
        if (string.IsNullOrWhiteSpace(_searchPlayer) || _searchPlayer.Length < 2)
            return;
        
        await CalculateHitRates();
    }
    
    private async Task CalculateHitRates()
    {
        try
        {
            _isLoading = true;
            _searchCompleted = false;
            StateHasChanged();
            
            // Fetch game results filtered by season
            var url = $"http://backend:8000/db/games/nba/list?limit=1000&season={_selectedSeason}";
            if (!string.IsNullOrEmpty(_searchPlayer))
                url += $"&player={Uri.EscapeDataString(_searchPlayer)}";
            
            var response = await Http.GetAsync(url);
            if (!response.IsSuccessStatusCode)
            {
                Snackbar.Add("Error loading game data", Severity.Error);
                _hitRates = new();
                _searchCompleted = true;
                return;
            }
            
            var json = await response.Content.ReadAsStringAsync();
            var games = System.Text.Json.JsonSerializer.Deserialize<GameResultsResponse>(json,
                new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            
            if (games?.Results == null || !games.Results.Any())
            {
                _hitRates = new();
                _searchCompleted = true;
                return;
            }
            
            // Store for multi-stat averages
            _allGameResults = games.Results.Where(g => !string.IsNullOrEmpty(g.PlayerName)).ToList();
            
            // Group by player
            var playerGames = _allGameResults
                .GroupBy(g => g.PlayerName)
                .ToList();
            
            _hitRates = playerGames.Select(pg =>
            {
                var allGames = pg.OrderByDescending(g => g.GameDate ?? "").ToList();
                var last5 = allGames.Take(5).ToList();
                var last10 = allGames.Take(10).ToList();
                
                int GetStatValue(GameResult g) => _selectedStat switch
                {
                    "pts" => g.Pts ?? 0,
                    "reb" => g.Reb ?? 0,
                    "ast" => g.Ast ?? 0,
                    "stl" => g.Stl ?? 0,
                    "blk" => g.Blk ?? 0,
                    "fg3" => g.Fg3 ?? 0,
                    _ => 0
                };
                
                return new HitRateResult
                {
                    PlayerName = pg.Key!,
                    Team = pg.FirstOrDefault()?.Team ?? "",
                    Last5Games = last5.Count,
                    Last5Hits = last5.Count(g => GetStatValue(g) >= _threshold),
                    Last10Games = last10.Count,
                    Last10Hits = last10.Count(g => GetStatValue(g) >= _threshold),
                    SeasonGames = allGames.Count,
                    SeasonHits = allGames.Count(g => GetStatValue(g) >= _threshold),
                    SeasonAvg = allGames.Count > 0 ? allGames.Average(g => GetStatValue(g)) : 0,
                };
            })
            .Where(h => h.SeasonGames > 0)
            .OrderByDescending(h => h.SeasonRate)
            .ThenByDescending(h => h.SeasonGames)
            .Take(50)
            .ToList();
            
            _searchCompleted = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            _hitRates = new();
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private Color GetRateColor(double rate)
    {
        if (rate >= 0.80) return Color.Success;
        if (rate >= 0.60) return Color.Warning;
        return Color.Error;
    }
    
    private string GetCardStyle(double rate)
    {
        if (rate >= 0.80) return "border-left: 4px solid var(--mud-palette-success);";
        if (rate >= 0.60) return "border-left: 4px solid var(--mud-palette-warning);";
        return "border-left: 4px solid var(--mud-palette-error);";
    }
    
    private string GetStatLabel(string stat) => stat switch
    {
        "pts" => "Points",
        "reb" => "Rebounds",
        "ast" => "Assists",
        "stl" => "Steals",
        "blk" => "Blocks",
        "fg3" => "3PM",
        _ => stat
    };
    
    // Calculate overall average for any stat across all displayed players
    private double GetOverallAvg(string stat)
    {
        if (!_allGameResults.Any()) return 0;
        
        var values = _allGameResults.Select(g => stat switch
        {
            "pts" => g.Pts ?? 0,
            "reb" => g.Reb ?? 0,
            "ast" => g.Ast ?? 0,
            "stl" => g.Stl ?? 0,
            "blk" => g.Blk ?? 0,
            "fg3" => g.Fg3 ?? 0,
            _ => 0
        }).Where(v => v > 0); // Only count games with stats
        
        return values.Any() ? values.Average() : 0;
    }
    
    // Models
    public class SeasonsResponse
    {
        public List<int> Seasons { get; set; } = new();
    }
    
    public class HitRateResult
    {
        public string PlayerName { get; set; } = "";
        public string Team { get; set; } = "";
        public int Last5Games { get; set; }
        public int Last5Hits { get; set; }
        public int Last10Games { get; set; }
        public int Last10Hits { get; set; }
        public int SeasonGames { get; set; }
        public int SeasonHits { get; set; }
        public double SeasonAvg { get; set; }
        
        public double Last5Rate => Last5Games > 0 ? (double)Last5Hits / Last5Games : 0;
        public double Last10Rate => Last10Games > 0 ? (double)Last10Hits / Last10Games : 0;
        public double SeasonRate => SeasonGames > 0 ? (double)SeasonHits / SeasonGames : 0;
    }
    
    public class GameResultsResponse
    {
        public List<GameResult> Results { get; set; } = new();
    }
    
    public class GameResult
    {
        [System.Text.Json.Serialization.JsonPropertyName("season")]
        public int Season { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("game_date")]
        public string? GameDate { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("player_name")]
        public string? PlayerName { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("team")]
        public string? Team { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("pts")]
        public int? Pts { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("reb")]
        public int? Reb { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("ast")]
        public int? Ast { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("stl")]
        public int? Stl { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("blk")]
        public int? Blk { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("fg3")]
        public int? Fg3 { get; set; }
    }
}
