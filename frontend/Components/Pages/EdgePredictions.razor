@page "/edge-predictions"
@rendermode InteractiveServer
@using MudBlazor
@inject HttpClient Http
@inject ISnackbar Snackbar

<PageTitle>Edge Predictions - Sports Betting Analyzer</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Class="mr-2" Color="Color.Warning" />
        Edge Predictions
    </MudText>
    <MudText Typo="Typo.subtitle1" Color="Color.Secondary" Class="mb-4">
        Find high-value players based on recent performance vs season average
    </MudText>

    <!-- Controls -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudStack Row="true" Spacing="4" AlignItems="AlignItems.Center">
            <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined">
                <MudButton Variant="@(_selectedSport == "nba" ? Variant.Filled : Variant.Outlined)"
                           OnClick="@(() => SelectSport("nba"))">
                    <MudIcon Icon="@Icons.Material.Filled.SportsBasketball" Class="mr-1" /> NBA
                </MudButton>
                <MudButton Variant="@(_selectedSport == "nfl" ? Variant.Filled : Variant.Outlined)"
                           OnClick="@(() => SelectSport("nfl"))">
                    <MudIcon Icon="@Icons.Material.Filled.SportsFootball" Class="mr-1" /> NFL
                </MudButton>
            </MudButtonGroup>
            
            <MudNumericField T="int" @bind-Value="_season" Label="Season" Min="2015" Max="2025"
                             Variant="Variant.Outlined" Dense="true" Style="width: 120px;" />
            
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadEdgeScores"
                       Disabled="@_isLoading">
                @if (_isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Calculate Edge
            </MudButton>
        </MudStack>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else if (_edgeData != null)
    {
        <!-- Legend -->
        <MudPaper Class="pa-3 mb-4" Elevation="1">
            <MudText Typo="Typo.subtitle2" Class="mb-2">Edge Score Formula:</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Edge = (Last 5 Games Avg - Season Avg) / Season Std Dev
            </MudText>
            <MudStack Row="true" Spacing="4" Class="mt-2">
                <MudChip T="string" Color="Color.Success" Size="Size.Small">üî• Hot (+1.0+)</MudChip>
                <MudChip T="string" Color="Color.Info" Size="Size.Small">üìà Warming (+0.5)</MudChip>
                <MudChip T="string" Color="Color.Default" Size="Size.Small">‚û°Ô∏è Steady (¬±0.5)</MudChip>
                <MudChip T="string" Color="Color.Warning" Size="Size.Small">üìâ Cooling (-0.5)</MudChip>
                <MudChip T="string" Color="Color.Error" Size="Size.Small">‚ùÑÔ∏è Cold (-1.0+)</MudChip>
            </MudStack>
        </MudPaper>

        <!-- Hot/Cold Summary Cards -->
        <MudGrid Class="mb-4">
            <!-- Hot Players -->
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="2" Style="border-left: 4px solid #4caf50;">
                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.Whatshot" Color="Color.Success" Class="mr-1" />
                        üî• Hottest Players
                    </MudText>
                    @if (_edgeData.HotPlayers.Any())
                    {
                        @foreach (var player in _edgeData.HotPlayers.Take(5))
                        {
                            <MudPaper Class="pa-2 mb-2" Elevation="0" Outlined="true">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <div>
                                        <MudText Typo="Typo.body1"><strong>@player.Player</strong></MudText>
                                        <MudText Typo="Typo.caption">@player.Team ‚Ä¢ @player.Position</MudText>
                                    </div>
                                    <MudStack AlignItems="AlignItems.End">
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small">
                                            +@player.EdgeScore
                                        </MudChip>
                                        <MudText Typo="Typo.caption">
                                            @player.RecentAvg (@player.PrimaryStat) vs @player.SeasonAvg avg
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        }
                    }
                    else
                    {
                        <MudText Color="Color.Secondary">No hot players found</MudText>
                    }
                </MudPaper>
            </MudItem>
            
            <!-- Cold Players -->
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="2" Style="border-left: 4px solid #f44336;">
                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.AcUnit" Color="Color.Error" Class="mr-1" />
                        ‚ùÑÔ∏è Coldest Players
                    </MudText>
                    @if (_edgeData.ColdPlayers.Any())
                    {
                        @foreach (var player in _edgeData.ColdPlayers.Take(5))
                        {
                            <MudPaper Class="pa-2 mb-2" Elevation="0" Outlined="true">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <div>
                                        <MudText Typo="Typo.body1"><strong>@player.Player</strong></MudText>
                                        <MudText Typo="Typo.caption">@player.Team ‚Ä¢ @player.Position</MudText>
                                    </div>
                                    <MudStack AlignItems="AlignItems.End">
                                        <MudChip T="string" Color="Color.Error" Size="Size.Small">
                                            @player.EdgeScore
                                        </MudChip>
                                        <MudText Typo="Typo.caption">
                                            @player.RecentAvg (@player.PrimaryStat) vs @player.SeasonAvg avg
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        }
                    }
                    else
                    {
                        <MudText Color="Color.Secondary">No cold players found</MudText>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Full Rankings Table -->
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">All Player Edge Scores (@_edgeData.TotalAnalyzed players)</MudText>
            
            <MudSimpleTable Dense="true" Hover="true" Striped="true">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Player</th>
                        <th>Team</th>
                        <th>Pos</th>
                        <th>Edge</th>
                        <th>Trend</th>
                        <th>Recent Avg</th>
                        <th>Season Avg</th>
                        <th>GP</th>
                        <th>Last 5</th>
                    </tr>
                </thead>
                <tbody>
                    @{ var rank = 1; }
                    @foreach (var player in _edgeData.Players)
                    {
                        <tr>
                            <td>@rank</td>
                            <td><strong>@player.Player</strong></td>
                            <td>@player.Team</td>
                            <td>@player.Position</td>
                            <td>
                                <MudChip T="string" Color="@GetEdgeColor(player.EdgeScore)" Size="Size.Small">
                                    @(player.EdgeScore >= 0 ? "+" : "")@player.EdgeScore
                                </MudChip>
                            </td>
                            <td>@player.Trend</td>
                            <td>@player.RecentAvg</td>
                            <td>@player.SeasonAvg</td>
                            <td>@player.GamesPlayed</td>
                            <td>
                                <span style="font-family: monospace; font-size: 0.8em;">
                                    @string.Join(", ", player.Last5)
                                </span>
                            </td>
                        </tr>
                        rank++;
                    }
                </tbody>
            </MudSimpleTable>
        </MudPaper>
        
        <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Secondary">
            Stat: @_edgeData.PrimaryStat ‚Ä¢ Season: @_edgeData.Season
        </MudText>
    }
    else
    {
        <MudAlert Severity="Severity.Info">
            Select a sport and click "Calculate Edge" to find high-value players.
        </MudAlert>
    }
</MudContainer>

@code {
    private string _selectedSport = "nba";
    private int _season = DateTime.Now.Year;
    private bool _isLoading = false;
    private EdgeResponse? _edgeData;

    private async Task SelectSport(string sport)
    {
        _selectedSport = sport;
        _edgeData = null;
    }

    private async Task LoadEdgeScores()
    {
        _isLoading = true;
        try
        {
            var url = $"http://localhost:8000/edge/{_selectedSport}/players?season={_season}&limit=50";
            _edgeData = await Http.GetFromJsonAsync<EdgeResponse>(url);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            _edgeData = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private Color GetEdgeColor(double edge)
    {
        return edge switch
        {
            > 1 => Color.Success,
            > 0.5 => Color.Info,
            < -1 => Color.Error,
            < -0.5 => Color.Warning,
            _ => Color.Default
        };
    }

    // Response classes
    public class EdgeResponse
    {
        public string Sport { get; set; } = "";
        public int Season { get; set; }
        public int TotalAnalyzed { get; set; }
        public string PrimaryStat { get; set; } = "";
        public List<PlayerEdge> Players { get; set; } = new();
        public List<PlayerEdge> HotPlayers { get; set; } = new();
        public List<PlayerEdge> ColdPlayers { get; set; } = new();
    }

    public class PlayerEdge
    {
        public string Player { get; set; } = "";
        public string Team { get; set; } = "";
        public string Position { get; set; } = "";
        public double EdgeScore { get; set; }
        public string Trend { get; set; } = "";
        public string TrendColor { get; set; } = "";
        public double SeasonAvg { get; set; }
        public double RecentAvg { get; set; }
        public int GamesPlayed { get; set; }
        public string PrimaryStat { get; set; } = "";
        public List<double> Last5 { get; set; } = new();
    }
}
