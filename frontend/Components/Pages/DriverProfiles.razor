@page "/driver-profiles"
@rendermode InteractiveServer
@using MudBlazor
@inject HttpClient Http
@inject ISnackbar Snackbar

<PageTitle>NASCAR Driver Profiles</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.SportsMotorsports" Class="mr-2" />
        NASCAR Driver Profiles
    </MudText>

    <MudGrid>
        <!-- Search & Selection -->
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">Find Driver</MudText>
                
                <!-- Series Selector -->
                <MudSelect T="string" Label="Series" Value="_selectedSeries" 
                           Variant="Variant.Outlined" Dense="true" Class="mb-3"
                           ValueChanged="@((string s) => OnSeriesChanged(s))">
                    <MudSelectItem Value="@("cup")">
                        <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Class="mr-2" Size="Size.Small" />
                        Cup Series
                    </MudSelectItem>
                    <MudSelectItem Value="@("xfinity")">
                        <MudIcon Icon="@Icons.Material.Filled.Stars" Class="mr-2" Size="Size.Small" />
                        Xfinity Series
                    </MudSelectItem>
                    <MudSelectItem Value="@("trucks")">
                        <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Class="mr-2" Size="Size.Small" />
                        Trucks Series
                    </MudSelectItem>
                </MudSelect>
                
                <MudAutocomplete T="string" Label="Search Driver"
                                 Value="_selectedDriver"
                                 ValueChanged="OnDriverSelected"
                                 SearchFunc="SearchDrivers"
                                 MaxItems="50"
                                 AdornmentIcon="@Icons.Material.Filled.Search"
                                 Variant="Variant.Outlined"
                                 Dense="true"
                                 Immediate="true"
                                 Placeholder="Type driver name..."
                                 Disabled="@string.IsNullOrEmpty(_selectedSeries)" />
                
                @if (_availableSeasons.Any())
                {
                    <MudSelect T="int?" Label="Season" @bind-Value="_selectedSeason" 
                               Variant="Variant.Outlined" Dense="true" Class="mt-3" Clearable="true">
                        @foreach (var season in _availableSeasons)
                        {
                            <MudSelectItem Value="@((int?)season)">@season</MudSelectItem>
                        }
                    </MudSelect>
                }
                
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-3" FullWidth="true"
                           OnClick="LoadProfile" Disabled="@(string.IsNullOrEmpty(_selectedDriver) || _isLoading)">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Load Profile
                </MudButton>
            </MudPaper>
            
            <!-- Series Info -->
            <MudAlert Severity="Severity.Info" Class="mt-2">
                @_selectedSeries switch
                {
                    "cup" => "NASCAR Cup Series - Top tier",
                    "xfinity" => "NASCAR Xfinity Series",
                    "trucks" => "NASCAR Truck Series",
                    _ => "Select a series to view drivers"
                }
            </MudAlert>
        </MudItem>

        <!-- Profile Display -->
        <MudItem xs="12" md="8">
            @if (_profile != null)
            {
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
                    <!-- Overview Tab -->
                    <MudTabPanel Text="Overview" Icon="@Icons.Material.Filled.Person">
                        <MudPaper Class="pa-4 mb-4" Elevation="1" Style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
                                <MudAvatar Size="Size.Large" Color="Color.Warning">
                                    @(_profile.Entity.Name?.Substring(0, 1) ?? "?")
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.h5" Style="color: white;">@_profile.Entity.Name</MudText>
                                    <MudText Typo="Typo.subtitle1" Style="color: rgba(255,255,255,0.8);">
                                        @GetSeriesDisplayName(_selectedSeries) Driver
                                    </MudText>
                                </div>
                                <MudSpacer />
                                <MudChip T="string" Color="Color.Warning" Size="Size.Small">@GetSeriesDisplayName(_selectedSeries)</MudChip>
                            </MudStack>
                        </MudPaper>

                        <!-- Last 5 Races Card -->
                        @if (_profile.RecentResults != null && _profile.RecentResults.Any())
                        {
                            <MudPaper Class="pa-4 mb-4" Elevation="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                                    <MudText Typo="Typo.h6">
                                        <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" />
                                        Last 5 Races
                                    </MudText>
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               Href="@($"/race-results?series={_selectedSeries}&driver={Uri.EscapeDataString(_profile.Entity.Name ?? "")}")">
                                        View All Results →
                                    </MudButton>
                                </MudStack>
                                
                                <MudSimpleTable Dense="true" Hover="true" Striped="true">
                                    <thead>
                                        <tr>
                                            <th>Season</th>
                                            <th>Track</th>
                                            <th>Finish</th>
                                            <th>Start</th>
                                            <th>Led</th>
                                            <th>Pts</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var result in _profile.RecentResults.Take(5))
                                        {
                                            <tr>
                                                <td>@result.Season</td>
                                                <td>
                                                    <MudTooltip Text="@result.Track">
                                                        @TruncateText(result.Track, 20)
                                                    </MudTooltip>
                                                </td>
                                                <td>
                                                    <MudChip T="string" Size="Size.Small" 
                                                             Color="@(result.FinishPosition <= 3 ? Color.Success : result.FinishPosition <= 10 ? Color.Info : Color.Default)">
                                                        P@(result.FinishPosition)
                                                    </MudChip>
                                                </td>
                                                <td>@(result.StartPosition?.ToString() ?? "-")</td>
                                                <td>
                                                    @if (result.LapsLed > 0)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">@result.LapsLed</MudChip>
                                                    }
                                                    else
                                                    {
                                                        @:0
                                                    }
                                                </td>
                                                <td>@(result.Points?.ToString() ?? "-")</td>
                                                <td>
                                                    @{ var status = result.GetStatus(); }
                                                    @if (!string.IsNullOrEmpty(status) && status.ToLower() != "running")
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Error">@status</MudChip>
                                                    }
                                                    else
                                                    {
                                                        <MudText Typo="Typo.caption" Color="Color.Success">✓</MudText>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </MudSimpleTable>
                            </MudPaper>
                        }

                        <!-- Stats Cards -->
                        @if (_profile.Stats.Any())
                        {
                            <MudText Typo="Typo.h6" Class="mb-2">@GetSeriesDisplayName(_selectedSeries) Statistics</MudText>
                            @foreach (var seasonStats in _profile.Stats.Take(3))
                            {
                                <MudText Typo="Typo.subtitle2" Class="mb-1">@seasonStats.Key Season</MudText>
                                <MudGrid Class="mb-3">
                                    @foreach (var stat in seasonStats.Value.Take(8))
                                    {
                                        <MudItem xs="6" sm="4" md="3">
                                            <MudPaper Class="pa-3 text-center" Elevation="1">
                                                <MudText Typo="Typo.h6" Color="Color.Primary">@stat.Value</MudText>
                                                <MudText Typo="Typo.caption">@stat.Key</MudText>
                                            </MudPaper>
                                        </MudItem>
                                    }
                                </MudGrid>
                            }
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">No @GetSeriesDisplayName(_selectedSeries) stats available for this driver.</MudAlert>
                        }
                    </MudTabPanel>

                    <!-- Recent Results Tab -->
                    <MudTabPanel Text="Recent Results" Icon="@Icons.Material.Filled.Timeline">
                        @if (_profile.RecentResults.Any())
                        {
                            <MudSimpleTable Dense="true" Hover="true" Striped="true">
                                <thead>
                                    <tr>
                                        <th>Season</th>
                                        <th>Track</th>
                                        <th>Start</th>
                                        <th>Finish</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var result in _profile.RecentResults)
                                    {
                                        <tr>
                                            <td>@result.Season</td>
                                            <td>@(result.Track ?? "-")</td>
                                            <td>@(result.StartPosition?.ToString() ?? "-")</td>
                                            <td>
                                                <MudChip T="string" Size="Size.Small" 
                                                         Color="@(result.FinishPosition <= 3 ? Color.Success : result.FinishPosition <= 10 ? Color.Info : Color.Default)">
                                                    P@(result.FinishPosition)
                                                </MudChip>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">No recent @GetSeriesDisplayName(_selectedSeries) results found.</MudAlert>
                        }
                    </MudTabPanel>

                    <!-- History Tab -->
                    <MudTabPanel Text="Full History" Icon="@Icons.Material.Filled.History">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="LoadFullHistory" 
                                       Disabled="_isLoadingHistory">
                                @if (_isLoadingHistory)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                }
                                Load Full History
                            </MudButton>
                            
                            @if (_historyYears.Any())
                            {
                                <MudSelect T="int?" Label="Year" Value="_historyYear" ValueChanged="OnHistoryYearChanged"
                                           Variant="Variant.Outlined" Dense="true" Style="width: 140px;">
                                    <MudSelectItem T="int?" Value="@((int?)null)">All Years</MudSelectItem>
                                    @foreach (var year in _historyYears)
                                    {
                                        <MudSelectItem T="int?" Value="@((int?)year)">@year</MudSelectItem>
                                    }
                                </MudSelect>
                            }
                        </MudStack>
                        
                        @if (_history != null && _history.Any())
                        {
                            var filteredHistory = _historyYear.HasValue ? _history.Where(h => h.Season == _historyYear.Value).ToList() : _history;
                            
                            <MudText Typo="Typo.subtitle2" Class="mb-2">
                                Showing @filteredHistory.Count @GetSeriesDisplayName(_selectedSeries) results
                                @if (_historyYear.HasValue) { <text> for @_historyYear</text> }
                            </MudText>
                            
                            <MudSimpleTable Dense="true" Hover="true" Striped="true">
                                <thead>
                                    <tr>
                                        <th>Season</th>
                                        <th>Track</th>
                                        <th>Start</th>
                                        <th>Finish</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var result in filteredHistory)
                                    {
                                        <tr>
                                            <td>@result.Season</td>
                                            <td>@(result.Track ?? "-")</td>
                                            <td>@(result.StartPosition?.ToString() ?? "-")</td>
                                            <td>
                                                <MudChip T="string" Size="Size.Small" 
                                                         Color="@(result.FinishPosition <= 3 ? Color.Success : result.FinishPosition <= 10 ? Color.Info : Color.Default)">
                                                    P@(result.FinishPosition)
                                                </MudChip>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        }
                    </MudTabPanel>
                </MudTabs>
            }
            else if (_isLoading)
            {
                <MudPaper Class="pa-8 d-flex flex-column align-center justify-center">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                    <MudText Class="mt-4">Loading @GetSeriesDisplayName(_selectedSeries) profile...</MudText>
                </MudPaper>
            }
            else
            {
                <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Elevation="1">
                    <MudIcon Icon="@Icons.Material.Filled.PersonSearch" Size="Size.Large" Color="Color.Secondary" />
                    <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-2">Search for a driver</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Select a series, then search for a driver</MudText>
                </MudPaper>
            }
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private string _selectedSeries = "cup";
    private string _selectedDriver = "";
    private int? _selectedSeason;
    private bool _isLoading = false;
    private bool _isLoadingHistory = false;
    
    private List<string> _driverList = new();
    private List<int> _availableSeasons = new();
    private DriverProfile? _profile;
    private List<RaceResult>? _history;
    
    // Year filter for history
    private int? _historyYear = null;
    private List<int> _historyYears = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDriverList();
    }

    private string GetSeriesDisplayName(string series) => series switch
    {
        "cup" => "Cup Series",
        "xfinity" => "Xfinity Series",
        "trucks" => "Trucks Series",
        _ => "NASCAR"
    };

    private string TruncateText(string? text, int maxLength) => 
        text != null && text.Length > maxLength ? text[..(maxLength - 3)] + "..." : text ?? "";

    private async Task OnSeriesChanged(string series)
    {
        _selectedSeries = series;
        _selectedDriver = "";
        _profile = null;
        _history = null;
        _availableSeasons.Clear();
        await LoadDriverList();
    }

    private async Task LoadDriverList()
    {
        try
        {
            var url = $"http://backend:8000/db/profiles/nascar/list?entity_type=driver&series={_selectedSeries}&limit=1000";
            var response = await Http.GetFromJsonAsync<ProfileListResponse>(url);
            if (response?.Entities != null)
            {
                _driverList = response.Entities.Select(e => e.Name).Distinct().ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading drivers: {ex.Message}", Severity.Warning);
        }
    }

    private Task<IEnumerable<string>> SearchDrivers(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult(_driverList.Take(50).AsEnumerable());
        
        return Task.FromResult(_driverList
            .Where(d => d.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Take(50)
            .AsEnumerable());
    }

    private async Task OnDriverSelected(string driver)
    {
        _selectedDriver = driver;
        _profile = null;
        _history = null;
        _availableSeasons.Clear();
        
        if (!string.IsNullOrEmpty(driver))
        {
            await LoadProfile();
        }
    }

    private async Task LoadProfile()
    {
        if (string.IsNullOrEmpty(_selectedDriver)) return;
        
        _isLoading = true;
        try
        {
            var url = $"http://backend:8000/db/profiles/nascar/{Uri.EscapeDataString(_selectedDriver)}?series={_selectedSeries}";
            if (_selectedSeason.HasValue)
            {
                url += $"&season={_selectedSeason.Value}";
            }
            
            _profile = await Http.GetFromJsonAsync<DriverProfile>(url);
            
            if (_profile?.AvailableSeasons != null)
            {
                _availableSeasons = _profile.AvailableSeasons;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading profile: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadFullHistory()
    {
        if (string.IsNullOrEmpty(_selectedDriver)) return;
        
        _isLoadingHistory = true;
        try
        {
            var url = $"http://backend:8000/db/profiles/nascar/{Uri.EscapeDataString(_selectedDriver)}/history?series={_selectedSeries}&limit=500";
            var response = await Http.GetFromJsonAsync<HistoryResponse>(url);
            _history = response?.History ?? new();
            
            // Extract unique years for the filter dropdown
            _historyYears = _history
                .Where(h => h.Season.HasValue)
                .Select(h => h.Season!.Value)
                .Distinct()
                .OrderByDescending(y => y)
                .ToList();
            
            // Reset year filter
            _historyYear = null;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading history: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoadingHistory = false;
        }
    }
    
    private void OnHistoryYearChanged(int? year)
    {
        _historyYear = year;
        StateHasChanged();
    }

    // Response models
    private class ProfileListResponse
    {
        public List<EntityInfo> Entities { get; set; } = new();
    }

    private class EntityInfo
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Type { get; set; } = "";
        public string? Series { get; set; }
        public System.Text.Json.JsonElement? Metadata { get; set; }
    }

    private class DriverProfile
    {
        public EntityInfo Entity { get; set; } = new();
        public string Sport { get; set; } = "";
        public List<int> AvailableSeasons { get; set; } = new();
        public Dictionary<string, Dictionary<string, object>> Stats { get; set; } = new();
        public List<RaceResult> RecentResults { get; set; } = new();
    }

    private class RaceResult
    {
        public DateTime? GameDate { get; set; }
        public int? Season { get; set; }
        public string? Track { get; set; }
        public string? Series { get; set; }
        public string? Metadata { get; set; }  // JSON string from API
        
        // Direct properties (used if API returns them directly)
        [System.Text.Json.Serialization.JsonPropertyName("finish_position")]
        public int? FinishPositionDirect { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("start_position")]
        public int? StartPositionDirect { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("laps_led")]
        public int? LapsLedDirect { get; set; }
        public int? Points { get; set; }
        public string? Status { get; set; }
        
        // Computed properties - try direct first, then parse from metadata
        public int FinishPosition => FinishPositionDirect ?? GetMetadataInt("finish") ?? 0;
        public int? StartPosition => StartPositionDirect ?? GetMetadataInt("start");
        public int LapsLed => LapsLedDirect ?? GetMetadataInt("led") ?? GetMetadataInt("laps_led") ?? 0;
        
        private int? GetMetadataInt(string key)
        {
            if (string.IsNullOrEmpty(Metadata)) return null;
            try
            {
                var doc = System.Text.Json.JsonDocument.Parse(Metadata);
                if (doc.RootElement.TryGetProperty(key, out var prop))
                {
                    return prop.ValueKind == System.Text.Json.JsonValueKind.Number 
                        ? prop.GetInt32() 
                        : null;
                }
            }
            catch { }
            return null;
        }
        
        public string? GetStatus()
        {
            if (!string.IsNullOrEmpty(Status)) return Status;
            if (string.IsNullOrEmpty(Metadata)) return null;
            try
            {
                var doc = System.Text.Json.JsonDocument.Parse(Metadata);
                if (doc.RootElement.TryGetProperty("status", out var prop))
                {
                    return prop.GetString();
                }
            }
            catch { }
            return null;
        }
    }

    private class HistoryResponse
    {
        public string Entity { get; set; } = "";
        public int Count { get; set; }
        public List<RaceResult> History { get; set; } = new();
    }
}
