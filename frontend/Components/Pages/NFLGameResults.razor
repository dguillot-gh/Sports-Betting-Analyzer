@page "/nfl-game-results"
@rendermode InteractiveServer
@using MudBlazor
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>NFL Game Results</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.SportsFootball" Class="mr-2" />
        NFL Game Results
    </MudText>

    <!-- Filters -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="6" md="2">
                <MudSelect T="int?" Label="Season" @bind-Value="_selectedSeason" 
                           Variant="Variant.Outlined" Dense="true" Clearable="true">
                    @foreach (var season in _availableSeasons)
                    {
                        <MudSelectItem T="int?" Value="@season">@season</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            
            <MudItem xs="12" sm="6" md="2">
                <MudSelect T="int?" Label="Week" @bind-Value="_selectedWeek" 
                           Variant="Variant.Outlined" Dense="true" Clearable="true">
                    <MudSelectItem T="int?" Value="@((int?)null)">All Weeks</MudSelectItem>
                    @for (int w = 1; w <= 18; w++)
                    {
                        <MudSelectItem T="int?" Value="@w">Week @w</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            
            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="string" Label="Team" @bind-Value="_selectedTeam" 
                           Variant="Variant.Outlined" Dense="true" Clearable="true"
                           MaxHeight="400">
                    <MudSelectItem Value="@((string?)null)">All Teams</MudSelectItem>
                    @foreach (var team in _nflTeams.OrderBy(t => t.Value))
                    {
                        <MudSelectItem Value="@team.Key">@team.Value</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            
            <MudItem xs="12" sm="6" md="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                           OnClick="LoadResults" Disabled="_isLoading" FullWidth="true">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Search
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Results -->
    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }
    
    @if (_games.Any())
    {
        <MudGrid>
            @foreach (var game in _games)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="2" Class="game-card">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Week @game.Week • @game.GameDate
                                </MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                @if (game.IsCompleted)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Final</MudChip>
                                }
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <!-- Away Team -->
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.SportsFootball" Size="Size.Small" />
                                        <MudText Typo="Typo.body1" Style="@(game.AwayScore > game.HomeScore ? "font-weight: bold;" : "")">
                                            @game.AwayTeam
                                        </MudText>
                                    </MudStack>
                                    <MudText Typo="Typo.h6" Style="@(game.AwayScore > game.HomeScore ? "font-weight: bold; color: #4caf50;" : "")">
                                        @game.AwayScore
                                    </MudText>
                                </MudStack>
                                
                                <!-- Home Team -->
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Small" />
                                        <MudText Typo="Typo.body1" Style="@(game.HomeScore > game.AwayScore ? "font-weight: bold;" : "")">
                                            @game.HomeTeam
                                        </MudText>
                                    </MudStack>
                                    <MudText Typo="Typo.h6" Style="@(game.HomeScore > game.AwayScore ? "font-weight: bold; color: #4caf50;" : "")">
                                        @game.HomeScore
                                    </MudText>
                                </MudStack>
                            </MudStack>
                        </MudCardContent>
                        @if (!string.IsNullOrEmpty(game.TopPerformer))
                        {
                            <MudCardActions>
                                <MudText Typo="Typo.caption">
                                    ⭐ @game.TopPerformer
                                </MudText>
                            </MudCardActions>
                        }
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
        
        <MudText Typo="Typo.caption" Class="mt-4">
            Showing @_games.Count games
        </MudText>
    }
    else if (!_isLoading && _hasSearched)
    {
        <MudAlert Severity="Severity.Info">No games found. Try adjusting your filters.</MudAlert>
    }
</MudContainer>

<style>
    .game-card:hover {
        transform: translateY(-2px);
        transition: transform 0.2s;
    }
</style>

@code {
    private int? _selectedSeason;
    private int? _selectedWeek;
    private string? _selectedTeam;
    private bool _isLoading = false;
    private bool _hasSearched = false;
    
    private List<int> _availableSeasons = new();
    private List<NFLGame> _games = new();
    
    private readonly Dictionary<string, string> _nflTeams = new()
    {
        { "ARI", "Cardinals" }, { "ATL", "Falcons" }, { "BAL", "Ravens" }, { "BUF", "Bills" },
        { "CAR", "Panthers" }, { "CHI", "Bears" }, { "CIN", "Bengals" }, { "CLE", "Browns" },
        { "DAL", "Cowboys" }, { "DEN", "Broncos" }, { "DET", "Lions" }, { "GB", "Packers" },
        { "HOU", "Texans" }, { "IND", "Colts" }, { "JAX", "Jaguars" }, { "KC", "Chiefs" },
        { "LV", "Raiders" }, { "LAC", "Chargers" }, { "LAR", "Rams" }, { "MIA", "Dolphins" },
        { "MIN", "Vikings" }, { "NE", "Patriots" }, { "NO", "Saints" }, { "NYG", "Giants" },
        { "NYJ", "Jets" }, { "PHI", "Eagles" }, { "PIT", "Steelers" }, { "SF", "49ers" },
        { "SEA", "Seahawks" }, { "TB", "Buccaneers" }, { "TEN", "Titans" }, { "WAS", "Commanders" }
    };

    protected override async Task OnInitializedAsync()
    {
        _availableSeasons = Enumerable.Range(2020, 6).Reverse().ToList();
        _selectedSeason = _availableSeasons.FirstOrDefault();
        await LoadResults();
    }

    private async Task LoadResults()
    {
        _isLoading = true;
        _hasSearched = true;
        StateHasChanged();
        
        try
        {
            var url = $"http://backend:8000/db/games/nfl/schedule?limit=50";
            
            if (_selectedSeason.HasValue)
                url += $"&season={_selectedSeason.Value}";
            if (_selectedWeek.HasValue)
                url += $"&week={_selectedWeek.Value}";
            if (!string.IsNullOrEmpty(_selectedTeam))
                url += $"&team={Uri.EscapeDataString(_selectedTeam)}";
            
            var response = await Http.GetFromJsonAsync<NFLScheduleResponse>(url);
            
            _games = (response?.Games ?? new())
                .Select(g => new NFLGame
                {
                    Week = g.Week ?? 0,
                    GameDate = g.GameDate ?? "TBD",
                    HomeTeam = g.HomeTeam ?? "Home",
                    AwayTeam = g.AwayTeam ?? "Away",
                    HomeScore = g.HomeScore ?? 0,
                    AwayScore = g.AwayScore ?? 0,
                    IsCompleted = g.IsCompleted ?? (g.HomeScore > 0 || g.AwayScore > 0),
                    TopPerformer = null
                })
                .OrderByDescending(g => g.Week)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading games: {ex.Message}");
            Snackbar.Add($"Error loading games: {ex.Message}", Severity.Warning);
            _games = new();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private List<NFLGame> GenerateSampleGames()
    {
        var random = new Random();
        var teams = _nflTeams.Keys.ToList();
        var games = new List<NFLGame>();
        
        for (int week = 16; week >= 1; week--)
        {
            for (int i = 0; i < 8; i++)
            {
                var homeIdx = random.Next(teams.Count);
                var awayIdx = (homeIdx + random.Next(1, teams.Count)) % teams.Count;
                
                games.Add(new NFLGame
                {
                    Week = week,
                    GameDate = $"Dec {random.Next(1, 28)}, {_selectedSeason ?? 2024}",
                    HomeTeam = _nflTeams[teams[homeIdx]],
                    AwayTeam = _nflTeams[teams[awayIdx]],
                    HomeScore = random.Next(10, 42),
                    AwayScore = random.Next(10, 42),
                    IsCompleted = true
                });
            }
        }
        
        return games.Take(50).ToList();
    }

    private class NFLScheduleResponse
    {
        public List<NFLGameItem> Games { get; set; } = new();
    }

    private class NFLGameItem
    {
        [System.Text.Json.Serialization.JsonPropertyName("week")]
        public int? Week { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("game_date")]
        public string? GameDate { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("home_team")]
        public string? HomeTeam { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("away_team")]
        public string? AwayTeam { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("home_score")]
        public int? HomeScore { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("away_score")]
        public int? AwayScore { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("is_completed")]
        public bool? IsCompleted { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("top_performer")]
        public string? TopPerformer { get; set; }
    }

    private class NFLGame
    {
        public int Week { get; set; }
        public string GameDate { get; set; } = "";
        public string HomeTeam { get; set; } = "";
        public string AwayTeam { get; set; } = "";
        public int HomeScore { get; set; }
        public int AwayScore { get; set; }
        public bool IsCompleted { get; set; }
        public string? TopPerformer { get; set; }
    }
}
