@page "/race-results"
@rendermode InteractiveServer
@using MudBlazor
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>NASCAR Race Results</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Class="mr-2" />
        NASCAR Race Results
    </MudText>

    <!-- Filters -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="string" Label="Series" @bind-Value="_selectedSeries" 
                           Variant="Variant.Outlined" Dense="true">
                    <MudSelectItem Value="@("cup")">Cup Series</MudSelectItem>
                    <MudSelectItem Value="@("xfinity")">Xfinity Series</MudSelectItem>
                    <MudSelectItem Value="@("trucks")">Trucks Series</MudSelectItem>
                </MudSelect>
            </MudItem>
            
            <MudItem xs="12" sm="6" md="2">
                <MudSelect T="int?" Label="Season" @bind-Value="_selectedSeason" 
                           Variant="Variant.Outlined" Dense="true" Clearable="true">
                    @foreach (var season in _availableSeasons)
                    {
                        <MudSelectItem T="int?" Value="@season">@season</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            
            <MudItem xs="12" sm="6" md="3">
                <MudAutocomplete T="string" Label="Driver"
                                 Value="_selectedDriver"
                                 ValueChanged="OnDriverChanged"
                                 SearchFunc="SearchDrivers"
                                 Variant="Variant.Outlined"
                                 Dense="true"
                                 Clearable="true"
                                 Placeholder="Filter by driver..." />
            </MudItem>
            
            <MudItem xs="12" sm="6" md="2">
                <MudSelect T="int?" Label="Results" @bind-Value="_finishFilter" 
                           Variant="Variant.Outlined" Dense="true" Clearable="true">
                    <MudSelectItem T="int?" Value="@((int?)1)">Wins Only</MudSelectItem>
                    <MudSelectItem T="int?" Value="@((int?)5)">Top 5</MudSelectItem>
                    <MudSelectItem T="int?" Value="@((int?)10)">Top 10</MudSelectItem>
                </MudSelect>
            </MudItem>
            
            <MudItem xs="12" sm="6" md="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                           OnClick="LoadResults" Disabled="_isLoading" FullWidth="true">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Search
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Results Table -->
    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }
    
    @if (_results.Any())
    {
        <MudPaper Elevation="2">
            <MudTable Items="@_results" Dense="true" Hover="true" Striped="true" 
                      FixedHeader="true" Height="600px">
                <HeaderContent>
                    <MudTh>Season</MudTh>
                    <MudTh>Race</MudTh>
                    <MudTh>Track</MudTh>
                    <MudTh>Driver</MudTh>
                    <MudTh>Finish</MudTh>
                    <MudTh>Start</MudTh>
                    <MudTh>Led</MudTh>
                    <MudTh>Pts</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Team</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Season">@context.Season</MudTd>
                    <MudTd DataLabel="Race">@($"R{context.RaceNum}")</MudTd>
                    <MudTd DataLabel="Track">
                        <span title="@context.RaceName">@TruncateTrack(context.Track)</span>
                    </MudTd>
                    <MudTd DataLabel="Driver">
                        <MudLink Href="@($"/driver-profiles?driver={Uri.EscapeDataString(context.Driver ?? "")}&series={_selectedSeries}")" 
                                 Color="Color.Primary">
                            @context.Driver
                        </MudLink>
                    </MudTd>
                    <MudTd DataLabel="Finish">
                        <MudChip T="string" Size="Size.Small" 
                                 Color="@GetFinishColor(context.Finish)">
                            P@(context.Finish)
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Start">@(context.Start?.ToString() ?? "-")</MudTd>
                    <MudTd DataLabel="Led">
                        @if (context.Led > 0)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">@context.Led</MudChip>
                        }
                        else
                        {
                            @:0
                        }
                    </MudTd>
                    <MudTd DataLabel="Pts">@(context.Pts?.ToString() ?? "-")</MudTd>
                    <MudTd DataLabel="Status">
                        @if (context.Status != null && context.Status.ToLower() != "running")
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Error">@context.Status</MudChip>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Success">Running</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Team">
                        <MudText Typo="Typo.caption">@TruncateTeam(context.Team)</MudText>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 50, 100, 200, 500 }" />
                </PagerContent>
            </MudTable>
        </MudPaper>
        
        <MudText Typo="Typo.caption" Class="mt-2">
            Showing @_results.Count of @_totalResults results
        </MudText>
    }
    else if (!_isLoading && _hasSearched)
    {
        <MudAlert Severity="Severity.Info">No results found. Try adjusting your filters.</MudAlert>
    }
</MudContainer>

@code {
    private string _selectedSeries = "cup";
    private int? _selectedSeason;
    private string? _selectedDriver;
    private int? _finishFilter;
    private bool _isLoading = false;
    private bool _hasSearched = false;
    
    private List<int> _availableSeasons = new();
    private List<RaceResultItem> _results = new();
    private int _totalResults = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadSeasons();
        await LoadResults();
    }

    private async Task LoadSeasons()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<SeasonsResponse>(
                $"http://backend:8000/db/races/nascar/seasons?series={_selectedSeries}");
            _availableSeasons = response?.Seasons ?? new List<int>();
        }
        catch
        {
            _availableSeasons = Enumerable.Range(2012, DateTime.Now.Year - 2011).Reverse().ToList();
        }
    }

    private async Task LoadResults()
    {
        _isLoading = true;
        _hasSearched = true;
        StateHasChanged();
        
        try
        {
            var url = $"http://backend:8000/db/races/nascar/list?series={_selectedSeries}&limit=500";
            
            if (_selectedSeason.HasValue)
                url += $"&season={_selectedSeason.Value}";
            if (!string.IsNullOrEmpty(_selectedDriver))
                url += $"&driver={Uri.EscapeDataString(_selectedDriver)}";
            if (_finishFilter.HasValue)
                url += $"&finish_max={_finishFilter.Value}";
            
            var response = await Http.GetFromJsonAsync<RaceResultsResponse>(url);
            _results = response?.Results ?? new();
            _totalResults = response?.Total ?? 0;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading results: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task<IEnumerable<string>> SearchDrivers(string value, CancellationToken ct)
    {
        if (string.IsNullOrEmpty(value) || value.Length < 2)
            return Enumerable.Empty<string>();
        
        try
        {
            var response = await Http.GetFromJsonAsync<DriversResponse>(
                $"http://backend:8000/db/races/nascar/drivers?series={_selectedSeries}&search={Uri.EscapeDataString(value)}&limit=20",
                ct);
            return response?.Drivers ?? Enumerable.Empty<string>();
        }
        catch
        {
            return Enumerable.Empty<string>();
        }
    }

    private void OnDriverChanged(string driver)
    {
        _selectedDriver = driver;
    }

    private Color GetFinishColor(int? finish) => finish switch
    {
        1 => Color.Success,
        <= 3 => Color.Success,
        <= 5 => Color.Info,
        <= 10 => Color.Info,
        _ => Color.Default
    };

    private string TruncateTrack(string? track) => 
        track != null && track.Length > 25 ? track[..22] + "..." : track ?? "";

    private string TruncateTeam(string? team) => 
        team != null && team.Length > 20 ? team[..17] + "..." : team ?? "";

    // Response Models
    private class SeasonsResponse
    {
        public List<int> Seasons { get; set; } = new();
    }

    private class DriversResponse
    {
        public List<string> Drivers { get; set; } = new();
    }

    private class RaceResultsResponse
    {
        public List<RaceResultItem> Results { get; set; } = new();
        public int Total { get; set; }
    }

    private class RaceResultItem
    {
        public int Id { get; set; }
        public int Season { get; set; }
        public string? Series { get; set; }
        public string? Track { get; set; }
        public int? RaceNum { get; set; }
        public string? RaceName { get; set; }
        public string? Driver { get; set; }
        public int? Finish { get; set; }
        public int? Start { get; set; }
        public int? Led { get; set; }
        public int? Laps { get; set; }
        public int? Pts { get; set; }
        public string? Status { get; set; }
        public string? Team { get; set; }
        public string? Make { get; set; }
        public double? Rating { get; set; }
    }
}
