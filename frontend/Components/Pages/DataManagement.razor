@page "/data-management"
@using SportsBettingAnalyzer.Services
@inject PythonMLServiceClient MLClient
@inject IHttpClientFactory HttpClientFactory
@inject ISnackbar Snackbar
@inject ILogger<DataManagement> Logger
@rendermode InteractiveServer

<PageTitle>Data Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <div>
            <MudText Typo="Typo.h4" GutterBottom="true">Data Management</MudText>
            <MudText Typo="Typo.subtitle1">
                Manage data sources, check for updates, and retrain models.
            </MudText>
        </div>
        <div>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.Refresh" 
                       OnClick="LoadStatus" 
                       Disabled="_isLoading">
                Refresh Status
            </MudButton>
        </div>
    </div>

    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }

    <MudGrid>
        <!-- NASCAR Card (GitHub) -->
        <MudItem xs="12" md="6" lg="4">
            <MudCard Elevation="3" Class="h-100">
                <MudCardHeader>
                    <CardHeaderAvatar>
                        <MudAvatar Color="Color.Error">
                            <MudIcon Icon="@Icons.Material.Filled.DirectionsCar" />
                        </MudAvatar>
                    </CardHeaderAvatar>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">NASCAR</MudText>
                        <MudText Typo="Typo.caption">nascaR.data (GitHub)</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (_dataStatus?.Nascar != null)
                    {
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.body2">
                                <MudIcon Icon="@Icons.Material.Filled.Storage" Size="Size.Small" Class="mr-1" />
                                Files: @GetFileCount(_dataStatus.Nascar.Files)
                            </MudText>
                             @if (!string.IsNullOrEmpty(_dataStatus.Nascar.LastCommit))
                            {
                                <MudText Typo="Typo.body2">
                                    <MudIcon Icon="@Icons.Material.Filled.Update" Size="Size.Small" Class="mr-1" />
                                    Last Commit: @FormatDate(_dataStatus.Nascar.LastCommit)
                                </MudText>
                            }
                            
                            <MudDivider Class="my-2"/>
                            
                            <MudText Typo="Typo.body2">
                                <MudIcon Icon="@Icons.Material.Filled.Psychology" Size="Size.Small" Class="mr-1" />
                                Models: @_dataStatus.Nascar.Models
                                @if (_dataStatus.Nascar.ModelAccuracy.HasValue)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Class="ml-2">
                                        @(_dataStatus.Nascar.ModelAccuracy.Value * 100).ToString("F1")% acc
                                    </MudChip>
                                }
                            </MudText>
                        </MudStack>
                    }
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.CloudDownload"
                               OnClick="@(() => UpdateData("nascar"))" 
                               Disabled="@_isUpdating">
                        Update
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Info"
                               StartIcon="@Icons.Material.Filled.AutoFixHigh"
                               OnClick="@(() => EnhanceData("nascar"))"
                               Disabled="@_isUpdating">
                        Enhance
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.ModelTraining"
                               OnClick="@(() => RetrainModel("nascar"))"
                               Disabled="@_isUpdating">
                        Train
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Warning"
                               StartIcon="@Icons.Material.Filled.DatasetLinked"
                               OnClick="@OpenRdaImportDialog"
                               Disabled="@(_isUpdating || _isRdaImporting)"
                               Title="Import directly from .rda files with pre-computed stats">
                        Import RDA
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <!-- Dynamic Sports Cards -->
        @foreach (var sport in new[] { "nfl", "nba" })
        {
            var status = sport == "nfl" ? _dataStatus?.Nfl : _dataStatus?.Nba;
            var color = sport == "nfl" ? Color.Success : Color.Warning;
            var icon = sport == "nfl" ? Icons.Material.Filled.SportsFootball : Icons.Material.Filled.SportsBasketball;
            
            <MudItem xs="12" md="6" lg="4">
                <MudCard Elevation="3" Class="h-100">
                    <MudCardHeader>
                        <CardHeaderAvatar>
                            <MudAvatar Color="@color">
                                <MudIcon Icon="@icon" />
                            </MudAvatar>
                        </CardHeaderAvatar>
                        <CardHeaderContent>
                            <div class="d-flex justify-space-between">
                                <div>
                                    <MudText Typo="Typo.h6">@sport.ToUpper()</MudText>
                                    <MudText Typo="Typo.caption">Kaggle Datasets</MudText>
                                </div>
                                <MudIconButton Icon="@Icons.Material.Filled.Sync" 
                                               Size="Size.Small" 
                                               OnClick="@(() => CheckUpdates(sport))" 
                                               Title="Check for Updates" />
                            </div>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (status != null)
                        {
                            <MudStack Spacing="2">
                                <!-- Datasets List -->
                                <MudText Typo="Typo.caption" Color="Color.Secondary">CONFIGURED DATASETS</MudText>
                                
                                @if (status.Datasets != null && status.Datasets.Any())
                                {
                                    @foreach (var ds in status.Datasets)
                                    {
                                        <MudPaper Class="pa-2 d-flex justify-space-between align-center" Elevation="0" Outlined="true">
                                            <div style="overflow: hidden; text-overflow: ellipsis;">
                                                <MudText Typo="Typo.body2" Style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                    <b>@ds.Id</b>
                                                </MudText>
                                                @if (!string.IsNullOrEmpty(ds.LastUpdated))
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Default">
                                                        <MudIcon Icon="@Icons.Material.Filled.CloudDone" Size="Size.Small" Class="mr-1" />
                                                        Downloaded: @FormatDate(ds.LastUpdated)
                                                    </MudText>
                                                }
                                                @if (_updatesAvailable.ContainsKey(ds.Id))
                                                {
                                                    var updateInfo = _updatesAvailable[ds.Id];
                                                    <MudTooltip Text="@($"Kaggle updated: {updateInfo}. Click to download new version.")">
                                                        <MudChip T="string" Color="Color.Warning" Size="Size.Small" Icon="@Icons.Material.Filled.NewReleases">Update Available</MudChip>
                                                    </MudTooltip>
                                                }
                                            </div>
                                            <div class="d-flex">
                                                <MudIconButton Icon="@Icons.Material.Filled.CloudDownload" 
                                                               Size="Size.Small" 
                                                               Color="Color.Primary"
                                                               OnClick="@(() => UpdateData(sport, ds.Id))"
                                                               Disabled="@_isUpdating"
                                                               Title="Update this dataset" />
                                                               
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                               Size="Size.Small" 
                                                               Color="Color.Error"
                                                               OnClick="@(() => RemoveDataset(sport, ds.Id))"
                                                               Disabled="@_isUpdating"
                                                               Title="Remove dataset" />
                                            </div>
                                        </MudPaper>
                                    }
                                }
                                else
                                {
                                    <MudAlert Severity="Severity.Info" Dense="true" Class="py-1">No datasets configured.</MudAlert>
                                }

                                <!-- Add Dataset Inline Form -->
                                @if (_addingDatasetSport == sport)
                                {
                                    <MudPaper Class="pa-2 mt-2" Elevation="0" Outlined="true" Style="background-color: var(--mud-palette-background-grey);">
                                        <MudTextField @bind-Value="_newDatasetId" 
                                                      Label="Kaggle Dataset ID" 
                                                      Placeholder="owner/dataset" 
                                                      Margin="Margin.Dense" 
                                                      Variant="Variant.Outlined" 
                                                      Class="mb-2"
                                                      AutoFocus="true" />
                                        <div class="d-flex justify-end gap-2">
                                            <MudButton Size="Size.Small" OnClick="@(() => _addingDatasetSport = null)">Cancel</MudButton>
                                            <MudButton Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled" 
                                                       OnClick="@(() => AddDataset(sport))"
                                                       Disabled="@(string.IsNullOrWhiteSpace(_newDatasetId))">Add</MudButton>
                                        </div>
                                    </MudPaper>
                                }
                                else
                                {
                                    <MudButton StartIcon="@Icons.Material.Filled.Add" 
                                               Size="Size.Small" 
                                               Variant="Variant.Text" 
                                               Color="Color.Primary"
                                               OnClick="@(() => { _addingDatasetSport = sport; _newDatasetId = ""; })">
                                        Add Dataset
                                    </MudButton>
                                }

                                <MudDivider Class="my-2"/>
                                
                                <MudText Typo="Typo.body2">
                                    <MudIcon Icon="@Icons.Material.Filled.Psychology" Size="Size.Small" Class="mr-1" />
                                    Models: @status.Models
                                </MudText>
                            </MudStack>
                        }
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Filled" Color="@color"
                                   StartIcon="@Icons.Material.Filled.CloudDownload"
                                   OnClick="@(() => OpenSportImportDialog(sport))"
                                   Disabled="@(_isUpdating || _isSportImporting)"
                                   Title="Import from nflverse/hoopR + Kaggle">
                            Import All
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                                   StartIcon="@Icons.Material.Filled.ModelTraining"
                                   OnClick="@(() => RetrainModel(sport))"
                                   Disabled="@_isUpdating">
                            Train
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Success"
                                   StartIcon="@Icons.Material.Filled.Storage"
                                   OnClick="@(() => SyncToDatabase(sport))"
                                   Disabled="@_isUpdating"
                                   Title="Import updated data to database">
                            Sync DB
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" Class="mt-4">
        <MudTabPanel Text="Update History" Icon="@Icons.Material.Filled.History">
            @if (_history.Any())
            {
                 <MudTable Items="@_history" Dense="true" Hover="true" Striped="true">
                    <HeaderContent>
                        <MudTh>Date</MudTh>
                        <MudTh>Topic</MudTh>
                        <MudTh>Details</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Date">@FormatDate(context["date"]?.ToString())</MudTd>
                        <MudTd DataLabel="Topic">@context["topic"]</MudTd>
                        <MudTd DataLabel="Details">
                            <MudText Typo="Typo.caption" Style="font-family: monospace;">
                                @System.Text.Json.JsonSerializer.Serialize(context["details"])
                            </MudText>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
            else
            {
                <MudText>No history available.</MudText>
            }
        </MudTabPanel>
        
        <MudTabPanel Text="Column Scan" Icon="@Icons.Material.Filled.ViewColumn">
            <MudStack Spacing="4">
                <MudText Typo="Typo.subtitle1">Column Mapping Status</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Scan your data to see which columns are mapped to standard names and which need attention.
                </MudText>
                
                <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary">
                    @foreach (var sport in new[] { "nba", "nfl", "nascar" })
                    {
                        <MudButton OnClick="@(() => ScanColumns(sport))" Disabled="@_isScanning">
                            Scan @sport.ToUpper()
                        </MudButton>
                    }
                </MudButtonGroup>
                
                @if (_isScanning)
                {
                    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
                }
                
                @if (_scanReport != null)
                {
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-2">@_scanReport.Sport.ToUpper() Column Report</MudText>
                        <MudStack Row="true" Spacing="4" Class="mb-3">
                            <MudChip T="string" Color="Color.Success" Size="Size.Small">
                                ‚úÖ @_scanReport.MappedCount Mapped
                            </MudChip>
                            <MudChip T="string" Color="@(_scanReport.UnmappedCount > 0 ? Color.Warning : Color.Default)" Size="Size.Small">
                                ‚ö†Ô∏è @_scanReport.UnmappedCount Unmapped
                            </MudChip>
                            <MudChip T="string" Color="Color.Info" Size="Size.Small">
                                üìä @_scanReport.TotalColumns Total
                            </MudChip>
                        </MudStack>
                        
                        @if (_scanReport.Unmapped.Any())
                        {
                            <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-3">
                                <strong>Unmapped columns:</strong> These are extra columns in your data not recognized by the alias system.
                            </MudAlert>
                            <MudPaper Class="pa-2" Outlined="true" Style="max-height: 150px; overflow-y: auto;">
                                @foreach (var col in _scanReport.Unmapped.Take(30))
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ma-1">@col</MudChip>
                                }
                                @if (_scanReport.Unmapped.Count > 30)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary">+@(_scanReport.Unmapped.Count - 30) more</MudChip>
                                }
                            </MudPaper>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Success" Dense="true">
                                All columns are mapped! ‚úÖ
                            </MudAlert>
                        }
                        
                        @* Required Columns Section *@
                        @if (_scanReport.RequiredColumns != null)
                        {
                            <MudDivider Class="my-3" />
                            <MudText Typo="Typo.subtitle2" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                                Required Columns for @_scanReport.Sport.ToUpper()
                            </MudText>
                            
                            <MudStack Row="true" Spacing="4" Class="mb-2">
                                <MudChip T="string" Color="Color.Success" Size="Size.Small">
                                    ‚úÖ @_scanReport.RequiredColumns.Found / @_scanReport.RequiredColumns.Total Found
                                </MudChip>
                                @if (_scanReport.RequiredColumns.Missing > 0)
                                {
                                    <MudChip T="string" Color="Color.Error" Size="Size.Small">
                                        ‚ùå @_scanReport.RequiredColumns.Missing Missing
                                    </MudChip>
                                }
                            </MudStack>
                            
                            @if (_scanReport.RequiredColumns.MissingList.Any())
                            {
                                <MudAlert Severity="Severity.Error" Dense="true" Class="mb-2">
                                    <strong>Missing required columns:</strong> These columns are needed but not found in your data.
                                </MudAlert>
                                <MudPaper Class="pa-2" Outlined="true">
                                    @foreach (var col in _scanReport.RequiredColumns.MissingList)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Error" Class="ma-1">@col</MudChip>
                                    }
                                </MudPaper>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Success" Dense="true">
                                    All required columns found! Ready for ML training. ‚úÖ
                                </MudAlert>
                            }
                        }
                        
                        <MudStack Row="true" Spacing="2" Class="mt-4">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Refresh"
                                       OnClick="@(() => RefreshData(_scanReport.Sport))"
                                       Disabled="@_isUpdating">
                                Refresh Data
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                                       StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                       OnClick="@(() => StandardizeData(_scanReport.Sport))"
                                       Disabled="@_isUpdating">
                                Standardize Columns
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                }
            </MudStack>
        </MudTabPanel>
        
        <MudTabPanel Text="Configuration Help" Icon="@Icons.Material.Filled.Help">
             <MudText Typo="Typo.subtitle2" GutterBottom="true">Kaggle API Setup</MudText>
            <MudText Typo="Typo.body2" Class="mb-2">
                To download NFL/NBA data, set these environment variables:
            </MudText>
            <MudPaper Class="pa-3 mb-3" Style="background: #1e1e1e; font-family: monospace;">
                <code style="color: #9cdcfe;">KAGGLE_USERNAME</code>=<span style="color: #ce9178;">your-username</span><br/>
                <code style="color: #9cdcfe;">KAGGLE_KEY</code>=<span style="color: #ce9178;">your-api-key</span>
            </MudPaper>
        </MudTabPanel>
    </MudTabs>

</MudContainer>

<!-- RDA Import Progress Dialog -->
<MudDialog @bind-Visible="_showRdaDialog" Options="_rdaDialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.DatasetLinked" Class="mr-2" />
            NASCAR RDA Import
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (!_isRdaImporting)
        {
            <!-- Import Options -->
            <MudStack Spacing="3">
                <MudAlert Severity="Severity.Info" Dense="true">
                    Import directly from .rda files with pre-computed season stats.
                </MudAlert>
                
                <MudSelect T="string" Label="Series" @bind-Value="_rdaSeries" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("all")">All Series</MudSelectItem>
                    <MudSelectItem Value="@("cup")">Cup Series</MudSelectItem>
                    <MudSelectItem Value="@("xfinity")">Xfinity Series</MudSelectItem>
                    <MudSelectItem Value="@("trucks")">Trucks Series</MudSelectItem>
                </MudSelect>
                
                <MudStack Row="true" Spacing="2">
                    <MudNumericField T="int" Label="Year Start" @bind-Value="_rdaYearStart" 
                                     Variant="Variant.Outlined" Min="2000" Max="2030" />
                    <MudNumericField T="int" Label="Year End" @bind-Value="_rdaYearEnd" 
                                     Variant="Variant.Outlined" Min="2000" Max="2030" />
                </MudStack>
                
                <MudCheckBox T="bool" @bind-Value="_rdaClearExisting" 
                             Label="Clear existing NASCAR data before import" Color="Color.Warning" />
            </MudStack>
        }
        else
        {
            <!-- Progress Display -->
            <MudStack Spacing="2">
                <MudProgressLinear Color="Color.Primary" Indeterminate="@(_rdaStatus?.Status == "running")" 
                                   Value="100" Class="mb-2" />
                
                <MudText Typo="Typo.subtitle2">
                    Status: <MudChip T="string" Size="Size.Small" 
                                     Color="@(_rdaStatus?.Status == "completed" ? Color.Success : 
                                              _rdaStatus?.Status == "failed" ? Color.Error : Color.Info)">
                        @(_rdaStatus?.Status ?? "unknown")
                    </MudChip>
                </MudText>
                
                @if (_rdaStatus?.StartedAt != null)
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Started: @FormatDate(_rdaStatus.StartedAt)
                    </MudText>
                }
                
                <MudPaper Class="pa-2 mt-2" Elevation="0" Outlined="true" 
                          Style="max-height: 200px; overflow-y: auto; background: #1a1a2e;">
                    @if (_rdaStatus?.Progress != null)
                    {
                        @foreach (var line in _rdaStatus.Progress)
                        {
                            <MudText Typo="Typo.caption" Style="font-family: monospace; color: #00ff88;">
                                @line
                            </MudText>
                        }
                    }
                </MudPaper>
                
                @if (_rdaStatus?.Error != null)
                {
                    <MudAlert Severity="Severity.Error" Dense="true">
                        @_rdaStatus.Error
                    </MudAlert>
                }
            </MudStack>
        }
    </DialogContent>
    <DialogActions>
        @if (!_isRdaImporting)
        {
            <MudButton OnClick="@CloseRdaDialog">Cancel</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@StartRdaImport">
                Start Import
            </MudButton>
        }
        else if (_rdaStatus?.Status == "completed" || _rdaStatus?.Status == "failed")
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@CloseRdaDialog">
                Close
            </MudButton>
        }
    </DialogActions>
</MudDialog>

<!-- NFL/NBA Import Dialog -->
<MudDialog @bind-Visible="_showSportImportDialog" Options="@_rdaDialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.CloudDownload" Class="mr-2" />
            Import @(_sportImportTarget?.ToUpper()) Data
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (!_isSportImporting)
        {
            <MudStack Spacing="3">
                <MudText Typo="Typo.body2">
                    This will download and import @(_sportImportTarget) data from:
                </MudText>
                <MudList T="string" Dense="true">
                    @if (_sportImportTarget == "nfl")
                    {
                        <MudListItem Icon="@Icons.Material.Filled.Code" Dense="true">nflverse-data (GitHub releases)</MudListItem>
                    }
                    else
                    {
                        <MudListItem Icon="@Icons.Material.Filled.Code" Dense="true">hoopR (Sportsdataverse)</MudListItem>
                    }
                    <MudListItem Icon="@Icons.Material.Filled.Dataset" Dense="true">Existing Kaggle datasets</MudListItem>
                </MudList>
                <MudCheckBox @bind-Value="_sportClearExisting" Color="Color.Warning" Dense="true">
                    Clear existing @(_sportImportTarget?.ToUpper()) data before import
                </MudCheckBox>
            </MudStack>
        }
        else
        {
            <MudStack Spacing="2">
                <MudProgressLinear Color="@(_sportStatus?.Status == "completed" ? Color.Success : Color.Primary)" 
                                    Indeterminate="@(_sportStatus?.Status == "running")" />
                <MudText Typo="Typo.body2">
                    Status: @(_sportStatus?.Status ?? "starting...")
                </MudText>
                
                <MudPaper Class="pa-2 mt-2" Elevation="0" Outlined="true" 
                          Style="max-height: 200px; overflow-y: auto; background: #1a1a2e;">
                    @if (_sportStatus?.Progress != null)
                    {
                        @foreach (var line in _sportStatus.Progress)
                        {
                            <MudText Typo="Typo.caption" Style="font-family: monospace; color: #00ff88;">
                                @line
                            </MudText>
                        }
                    }
                </MudPaper>
                
                @if (_sportStatus?.Error != null)
                {
                    <MudAlert Severity="Severity.Error" Dense="true">
                        @_sportStatus.Error
                    </MudAlert>
                }
            </MudStack>
        }
    </DialogContent>
    <DialogActions>
        @if (!_isSportImporting)
        {
            <MudButton OnClick="@CloseSportImportDialog">Cancel</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@StartSportImport">
                Start Import
            </MudButton>
        }
        else if (_sportStatus?.Status == "completed" || _sportStatus?.Status == "failed")
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@CloseSportImportDialog">
                Close
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    private DataStatusResponse? _dataStatus;
    private bool _isLoading = true;
    private bool _isUpdating = false;
    
    // UI State for Adding Dataset
    private string? _addingDatasetSport;
    private string _newDatasetId = "";
    
    // Updates
    private Dictionary<string, object> _updatesAvailable = new();
    
    // History
    private List<Dictionary<string, object>> _history = new();
    
    // Column Scan
    private bool _isScanning = false;
    private ColumnScanReport? _scanReport;
    
    // RDA Import Dialog
    private bool _showRdaDialog = false;
    private bool _isRdaImporting = false;
    private string _rdaSeries = "all";
    private int _rdaYearStart = 2012;
    private int _rdaYearEnd = DateTime.Now.Year;
    private bool _rdaClearExisting = false;
    private RdaImportStatus? _rdaStatus;
    private System.Threading.Timer? _rdaPollTimer;
    private DialogOptions _rdaDialogOptions = new() { MaxWidth = MaxWidth.Small, FullWidth = true };
    
    // NFL/NBA Import Dialog
    private bool _showSportImportDialog = false;
    private bool _isSportImporting = false;
    private string? _sportImportTarget;
    private bool _sportClearExisting = false;
    private SportImportStatus? _sportStatus;
    private System.Threading.Timer? _sportPollTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadStatus();
        await LoadHistory();
    }

    private async Task LoadStatus()
    {
        try
        {
            _isLoading = true;
            _dataStatus = await MLClient.GetDataStatusAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading status");
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private async Task LoadHistory()
    {
        // Load history for all sports and merge?
        // Or just show generic list. For now let's load NASCAr + NBA history
        var allHistory = new List<Dictionary<string, object>>();
        foreach(var sport in new[]{"nascar", "nba", "nfl"})
        {
            var h = await MLClient.GetHistoryAsync(sport);
            allHistory.AddRange(h);
        }
        
        // Sort by date desc
        _history = allHistory.OrderByDescending(x => x.ContainsKey("date") ? x["date"].ToString() : "").ToList();
    }

    private async Task AddDataset(string sport)
    {
        if (string.IsNullOrWhiteSpace(_newDatasetId)) return;
        
        try
        {
            _isUpdating = true;
            var success = await MLClient.AddDatasetAsync(sport, _newDatasetId);
            if (success)
            {
                Snackbar.Add($"Dataset {_newDatasetId} added!", Severity.Success);
                _addingDatasetSport = null;
                _newDatasetId = "";
                await LoadStatus();
            }
            else
            {
                Snackbar.Add("Failed to add dataset. Check ID and permissions.", Severity.Error);
            }
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUpdating = false;
        }
    }
    
    private async Task RemoveDataset(string sport, string id)
    {
        // Confirm?
        try
        {
            _isUpdating = true;
            var success = await MLClient.RemoveDatasetAsync(sport, id);
            if (success)
            {
                Snackbar.Add("Dataset removed.", Severity.Success);
                await LoadStatus();
            }
            else
            {
                 Snackbar.Add("Failed to remove dataset.", Severity.Error);
            }
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUpdating = false;
        }
    }

    private async Task UpdateData(string sport, string? dataset = null)
    {
        try
        {
            _isUpdating = true;
            Snackbar.Add($"Updating {sport}{(dataset!=null ? " - "+dataset : "")}...", Severity.Info);
            
            var result = await MLClient.UpdateDataAsync(sport, dataset);
            
            if (result.Success)
            {
                Snackbar.Add("Update successful!", Severity.Success);
                await LoadStatus();
                await LoadHistory();
            }
            else
            {
                Snackbar.Add("Update failed.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUpdating = false;
        }
    }

    private async Task CheckUpdates(string sport)
    {
        try
        {
            Snackbar.Add($"Checking for updates ({sport})...", Severity.Info);
            var updates = await MLClient.CheckUpdatesAsync(sport);
            
            int count = 0;
            if (updates != null)
            {
                foreach(var kvp in updates)
                {
                    // Logic to check if newer?
                    // For now just assume if present in response it might be relevant
                    _updatesAvailable[kvp.Key] = kvp.Value;
                    count++;
                }
            }
            
            if (count > 0)
                 Snackbar.Add($"Found updates for {count} datasets!", Severity.Success);
            else
                 Snackbar.Add("No updates found.", Severity.Success);
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Error checking updates: {ex.Message}", Severity.Error);
        }
    }

    private async Task RetrainModel(string sport)
    {
         try
        {
            _isUpdating = true;
            Snackbar.Add($"Starting Training for {sport}...", Severity.Info);
            var result = await MLClient.RetrainModelAsync(sport);
            if (result.Success)
            {
                Snackbar.Add("Training Complete!", Severity.Success);
                await LoadStatus();
            }
            else
            {
                 Snackbar.Add("Training Failed.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUpdating = false;
        }
    }
    
    private async Task EnhanceData(string sport)
    {
         // Same as before...
         try
        {
            _isUpdating = true;
            Snackbar.Add($"Enhancing {sport}...", Severity.Info);
            var result = await MLClient.EnhanceDataAsync(sport);
            if (result.Success)
            {
                Snackbar.Add("Enhanced successfully!", Severity.Success);
                await LoadStatus();
            }
            else
            {
                 Snackbar.Add("Enhance Failed.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUpdating = false;
        }
    }

    private string FormatDate(string? isoDate)
    {
        if (string.IsNullOrEmpty(isoDate)) return "";
        if (DateTime.TryParse(isoDate, out var date))
            return date.ToLocalTime().ToString("MMM d, HH:mm");
        return isoDate;
    }
    
    private int GetFileCount(System.Text.Json.JsonElement? files)
    {
        if (files == null || !files.HasValue) return 0;
        var elem = files.Value;
        if (elem.ValueKind == System.Text.Json.JsonValueKind.Array) return elem.GetArrayLength();
        if (elem.ValueKind == System.Text.Json.JsonValueKind.Object) return elem.EnumerateObject().Count();
        return 0;
    }
    
    // ===== Column Scan Methods =====
    
    private async Task ScanColumns(string sport)
    {
        _isScanning = true;
        _scanReport = null;
        StateHasChanged();
        
        try
        {
            using var http = new HttpClient();
            var response = await http.GetFromJsonAsync<ColumnScanReport>($"http://localhost:8000/data/scan/{sport}");
            _scanReport = response;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Scan failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isScanning = false;
        }
    }
    
    private async Task RefreshData(string sport)
    {
        _isUpdating = true;
        try
        {
            using var http = new HttpClient();
            var response = await http.PostAsync($"http://localhost:8000/data/refresh/{sport}", null);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"{sport.ToUpper()} data refreshed!", Severity.Success);
                await ScanColumns(sport);
            }
            else
            {
                Snackbar.Add("Refresh failed", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUpdating = false;
        }
    }
    
    private async Task SyncToDatabase(string sport)
    {
        _isUpdating = true;
        try
        {
            Snackbar.Add($"Syncing {sport.ToUpper()} data to database...", Severity.Info);
            
            using var http = new HttpClient();
            http.Timeout = TimeSpan.FromMinutes(10); // Long timeout for large imports
            
            var response = await http.PostAsync($"http://backend:8000/db/import/csv/{sport}", null);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"{sport.ToUpper()} data synced to database! Check import history for details.", Severity.Success);
                Logger.LogInformation("Database sync triggered for {Sport}: {Result}", sport, result);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Sync failed: {error}", Severity.Error);
            }
        }
        catch (HttpRequestException ex)
        {
            // Try localhost if backend hostname fails
            try
            {
                using var http2 = new HttpClient();
                http2.Timeout = TimeSpan.FromMinutes(10);
                var response = await http2.PostAsync($"http://localhost:8000/db/import/csv/{sport}", null);
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add($"{sport.ToUpper()} data synced to database!", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Sync failed - check server logs", Severity.Error);
                }
            }
            catch
            {
                Snackbar.Add($"Error connecting to backend: {ex.Message}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            Logger.LogError(ex, "Database sync failed for {Sport}", sport);
        }
        finally
        {
            _isUpdating = false;
        }
    }
    
    private async Task StandardizeData(string sport)
    {
        _isUpdating = true;
        try
        {
            using var http = new HttpClient();
            var response = await http.PostAsync($"http://localhost:8000/data/standardize/{sport}?save=true", null);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"{sport.ToUpper()} columns standardized!", Severity.Success);
                await ScanColumns(sport);
            }
            else
            {
                Snackbar.Add("Standardize failed", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUpdating = false;
        }
    }
    
    // Model for scan report
    public class ColumnScanReport
    {
        public string Sport { get; set; } = "";
        public int TotalColumns { get; set; }
        public int MappedCount { get; set; }
        public int UnmappedCount { get; set; }
        public Dictionary<string, string> Mapped { get; set; } = new();
        public List<string> Unmapped { get; set; } = new();
        public Dictionary<string, string> Suggestions { get; set; } = new();
        public RequiredColumnsInfo? RequiredColumns { get; set; }
    }
    
    public class RequiredColumnsInfo
    {
        public int Total { get; set; }
        public int Found { get; set; }
        public int Missing { get; set; }
        public List<string> FoundList { get; set; } = new();
        public List<string> MissingList { get; set; } = new();
    }
    
    // ===== RDA Import Methods =====
    
    private void OpenRdaImportDialog()
    {
        _isRdaImporting = false;
        _rdaStatus = null;
        _showRdaDialog = true;
    }
    
    private void CloseRdaDialog()
    {
        _showRdaDialog = false;
        _rdaPollTimer?.Dispose();
        _rdaPollTimer = null;
        _isRdaImporting = false;
    }
    
    private async Task StartRdaImport()
    {
        _isRdaImporting = true;
        _rdaStatus = new RdaImportStatus { Status = "starting", Progress = new List<string>() };
        StateHasChanged();
        
        try
        {
            using var http = new HttpClient();
            http.Timeout = TimeSpan.FromMinutes(30);
            
            var url = $"http://backend:8000/db/import/nascar/rda?series={_rdaSeries}&year_start={_rdaYearStart}&year_end={_rdaYearEnd}&clear_existing={_rdaClearExisting.ToString().ToLower()}";
            var response = await http.PostAsync(url, null);
            
            if (response.IsSuccessStatusCode)
            {
                // Start polling for status
                _rdaPollTimer = new System.Threading.Timer(async _ => await PollRdaStatus(), null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(2));
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                _rdaStatus = new RdaImportStatus { Status = "failed", Error = error };
            }
        }
        catch (HttpRequestException)
        {
            // Try localhost
            try
            {
                using var http2 = new HttpClient();
                http2.Timeout = TimeSpan.FromMinutes(30);
                var url = $"http://localhost:8000/db/import/nascar/rda?series={_rdaSeries}&year_start={_rdaYearStart}&year_end={_rdaYearEnd}&clear_existing={_rdaClearExisting.ToString().ToLower()}";
                var response = await http2.PostAsync(url, null);
                
                if (response.IsSuccessStatusCode)
                {
                    _rdaPollTimer = new System.Threading.Timer(async _ => await PollRdaStatus(), null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(2));
                }
            }
            catch (Exception ex)
            {
                _rdaStatus = new RdaImportStatus { Status = "failed", Error = ex.Message };
            }
        }
        catch (Exception ex)
        {
            _rdaStatus = new RdaImportStatus { Status = "failed", Error = ex.Message };
        }
        
        StateHasChanged();
    }
    
    private async Task PollRdaStatus()
    {
        try
        {
            using var http = new HttpClient();
            RdaImportStatus? status = null;
            
            try
            {
                status = await http.GetFromJsonAsync<RdaImportStatus>("http://backend:8000/db/import/nascar/status");
            }
            catch
            {
                status = await http.GetFromJsonAsync<RdaImportStatus>("http://localhost:8000/db/import/nascar/status");
            }
            
            if (status != null)
            {
                _rdaStatus = status;
                await InvokeAsync(StateHasChanged);
                
                // Stop polling when complete or failed
                if (status.Status == "completed" || status.Status == "failed")
                {
                    _rdaPollTimer?.Dispose();
                    _rdaPollTimer = null;
                    
                    if (status.Status == "completed")
                    {
                        await InvokeAsync(async () =>
                        {
                            Snackbar.Add("RDA import completed successfully!", Severity.Success);
                            await LoadStatus();
                        });
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error polling RDA status");
        }
    }
    
    // Model for RDA import status
    public class RdaImportStatus
    {
        public string Status { get; set; } = "idle";
        public string? StartedAt { get; set; }
        public string? CompletedAt { get; set; }
        public List<string>? Progress { get; set; }
        public object? Result { get; set; }
        public string? Error { get; set; }
    }
    
    // Model for NFL/NBA import status (same structure)
    public class SportImportStatus
    {
        public string Status { get; set; } = "idle";
        public string? StartedAt { get; set; }
        public string? CompletedAt { get; set; }
        public List<string>? Progress { get; set; }
        public object? Result { get; set; }
        public string? Error { get; set; }
    }
    
    // Sport Import Methods
    private void OpenSportImportDialog(string sport)
    {
        _sportImportTarget = sport;
        _sportClearExisting = false;
        _sportStatus = null;
        _showSportImportDialog = true;
    }
    
    private void CloseSportImportDialog()
    {
        _showSportImportDialog = false;
        _isSportImporting = false;
        _sportPollTimer?.Dispose();
        _sportPollTimer = null;
    }
    
    private async Task StartSportImport()
    {
        if (string.IsNullOrEmpty(_sportImportTarget)) return;
        
        try
        {
            _isSportImporting = true;
            _sportStatus = new SportImportStatus { Status = "running", Progress = new List<string> { $"Starting {_sportImportTarget.ToUpper()} import..." } };
            StateHasChanged();
            
            // Call the import API
            var http = HttpClientFactory.CreateClient("PythonML");
            var response = await http.PostAsync(
                $"/db/import/{_sportImportTarget}?clear_existing={_sportClearExisting.ToString().ToLower()}",
                null
            );
            
            if (!response.IsSuccessStatusCode)
            {
                _sportStatus.Status = "failed";
                _sportStatus.Error = "Failed to start import";
                return;
            }
            
            // Start polling
            _sportPollTimer = new System.Threading.Timer(
                async _ => await PollSportStatus(),
                null,
                TimeSpan.FromSeconds(2),
                TimeSpan.FromSeconds(2)
            );
        }
        catch (Exception ex)
        {
            _sportStatus = new SportImportStatus 
            { 
                Status = "failed", 
                Error = ex.Message,
                Progress = new List<string> { $"Error: {ex.Message}" }
            };
        }
    }
    
    private async Task PollSportStatus()
    {
        if (string.IsNullOrEmpty(_sportImportTarget)) return;
        
        try
        {
            var http = HttpClientFactory.CreateClient("PythonML");
            var response = await http.GetAsync($"/db/import/{_sportImportTarget}/status");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var status = System.Text.Json.JsonSerializer.Deserialize<SportImportStatus>(json, new System.Text.Json.JsonSerializerOptions 
                { 
                    PropertyNameCaseInsensitive = true 
                });
                
                if (status != null)
                {
                    _sportStatus = status;
                    await InvokeAsync(StateHasChanged);
                    
                    // Stop polling when complete or failed
                    if (status.Status == "completed" || status.Status == "failed")
                    {
                        _sportPollTimer?.Dispose();
                        _sportPollTimer = null;
                        
                        if (status.Status == "completed")
                        {
                            await InvokeAsync(async () =>
                            {
                                Snackbar.Add($"{_sportImportTarget?.ToUpper()} import completed successfully!", Severity.Success);
                                await LoadStatus();
                            });
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error polling sport import status");
        }
    }
}

