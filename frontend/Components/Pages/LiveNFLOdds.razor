@page "/live-nfl-odds"
@rendermode InteractiveServer
@using MudBlazor
@inject HttpClient Http
@inject ISnackbar Snackbar

<PageTitle>Live NFL Odds - Sports Betting Analyzer</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Spacing="4">
        <!-- Header -->
        <MudPaper Class="pa-4" Elevation="2">
            <div class="d-flex align-center justify-space-between flex-wrap" style="gap: 16px;">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.SportsFootball" Size="Size.Large" Color="Color.Primary" Class="mr-3" />
                    <div>
                        <MudText Typo="Typo.h5">Live NFL Odds & Predictions</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Real-time odds with model analysis</MudText>
                    </div>
                </div>
                
                <div class="d-flex align-center" style="gap: 12px;">
                    <MudSelect T="string" @bind-Value="_selectedSportsbook" Label="Sportsbook" Dense="true"
                               Variant="Variant.Outlined" Style="min-width: 160px;">
                        @foreach (var book in _sportsbooks)
                        {
                            <MudSelectItem Value="@book">@FormatBookName(book)</MudSelectItem>
                        }
                    </MudSelect>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="RefreshOdds" 
                               Disabled="_isLoading" StartIcon="@Icons.Material.Filled.Refresh">
                        Refresh
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="RunAnalysis" 
                               Disabled="_isLoading || !_games.Any()" StartIcon="@Icons.Material.Filled.Analytics">
                        @if (_isAnalyzing)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        }
                        Run Analysis
                    </MudButton>
                </div>
            </div>
        </MudPaper>

        @if (_isLoading || _isAnalyzing)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
        }

        <!-- Value Bets Summary -->
        @if (_analyzedGames.Any(g => g.HasValue))
        {
            <MudAlert Severity="Severity.Success" Icon="@Icons.Material.Filled.Whatshot">
                <strong>@_analyzedGames.Count(g => g.HasValue) Value Bet(s) Found!</strong>
                @foreach (var game in _analyzedGames.Where(g => g.HasValue))
                {
                    <MudText Typo="Typo.body2">
                        @game.AwayTeam @@ @game.HomeTeam: @string.Join(", ", game.ValueBets)
                    </MudText>
                }
            </MudAlert>
        }

        @if (_analyzedGames.Any())
        {
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                @_analyzedGames.Count games analyzed via @FormatBookName(_selectedSportsbook)
            </MudText>
            
            <MudGrid>
                @foreach (var game in _analyzedGames)
                {
                    <MudItem xs="12" md="6">
                        <MudCard Elevation="3" Style="@(game.HasValue ? "border-left: 4px solid #4caf50;" : "")">
                            <MudCardHeader Style="padding-bottom: 8px;">
                                <CardHeaderContent>
                                    <div class="d-flex justify-space-between align-center">
                                        <div class="text-center" style="flex: 1;">
                                            <MudText Typo="Typo.h6">@game.AwayTeam</MudText>
                                            <MudText Typo="Typo.caption">@(game.AwayWinProbability.HasValue ? $"{(game.AwayWinProbability.Value * 100):F0}%" : "")</MudText>
                                        </div>
                                        <div class="mx-2">
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">@@</MudText>
                                        </div>
                                        <div class="text-center" style="flex: 1;">
                                            <MudText Typo="Typo.h6">@game.HomeTeam</MudText>
                                            <MudText Typo="Typo.caption">@(game.HomeWinProbability.HasValue ? $"{(game.HomeWinProbability.Value * 100):F0}%" : "")</MudText>
                                        </div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(game.PredictedWinner))
                                    {
                                        <MudChip T="string" Color="Color.Primary" Size="Size.Small" Class="mt-2">
                                            Pick: @game.PredictedWinner (@game.ConfidenceLevel)
                                        </MudChip>
                                    }
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent Style="padding-top: 0;">
                                <MudDivider Class="mb-3" />
                                <MudGrid Spacing="2">
                                    <MudItem xs="4">
                                        <MudText Typo="Typo.overline" Color="Color.Secondary">MONEYLINE</MudText>
                                        <div class="d-flex flex-column">
                                            <MudText Typo="Typo.body2">@game.AwayTeam: @FormatOdds(game.AwayMoneyline)</MudText>
                                            <MudText Typo="Typo.body2">@game.HomeTeam: @FormatOdds(game.HomeMoneyline)</MudText>
                                        </div>
                                        @if (game.MlValue)
                                        {
                                            <MudChip T="string" Color="Color.Success" Size="Size.Small">
                                                @game.MlPick +@(game.HomeMlEdge)%
                                            </MudChip>
                                        }
                                    </MudItem>
                                    
                                    <MudItem xs="4">
                                        <MudText Typo="Typo.overline" Color="Color.Secondary">SPREAD</MudText>
                                        <MudText Typo="Typo.body1">@(game.Spread.HasValue ? FormatSpread(game.Spread.Value) : "N/A")</MudText>
                                        @if (game.SpreadValue)
                                        {
                                            <MudChip T="string" Color="Color.Success" Size="Size.Small">
                                                @game.SpreadPick @(game.SpreadEdge > 0 ? "+" : "")@game.SpreadEdge
                                            </MudChip>
                                        }
                                        else if (!string.IsNullOrEmpty(game.SpreadPick))
                                        {
                                            <MudText Typo="Typo.caption">Pick: @game.SpreadPick</MudText>
                                        }
                                    </MudItem>
                                    
                                    <MudItem xs="4">
                                        <MudText Typo="Typo.overline" Color="Color.Secondary">O/U TOTAL</MudText>
                                        <MudText Typo="Typo.body1">@(game.OverUnder.HasValue ? game.OverUnder.Value.ToString() : "N/A")</MudText>
                                        @if (game.OuValue)
                                        {
                                            <MudChip T="string" Color="Color.Success" Size="Size.Small">
                                                @game.OuPick @(game.OuEdge > 0 ? "+" : "")@game.OuEdge
                                            </MudChip>
                                        }
                                        else if (!string.IsNullOrEmpty(game.OuPick))
                                        {
                                            <MudText Typo="Typo.caption">Pick: @game.OuPick</MudText>
                                        }
                                    </MudItem>
                                </MudGrid>
                                
                                @if (game.PredictedTotal.HasValue)
                                {
                                    <MudDivider Class="my-2" />
                                    <div class="d-flex justify-space-between">
                                        <MudText Typo="Typo.caption">
                                            Pred Total: <strong>@game.PredictedTotal</strong>
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            Pred Margin: <strong>@(game.PredictedMargin > 0 ? "+" : "")@game.PredictedMargin</strong>
                                        </MudText>
                                    </div>
                                }
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
        else if (_games.Any() && !_isAnalyzing)
        {
            <MudAlert Severity="Severity.Info" Class="mb-3">
                Click <strong>Run Analysis</strong> to get predictions and value bet recommendations!
            </MudAlert>
            <MudGrid>
                @foreach (var game in _games)
                {
                    <MudItem xs="12" md="6" lg="4">
                        <MudCard Elevation="2">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <div class="d-flex justify-space-between align-center">
                                        <MudText Typo="Typo.h6">@game.AwayTeam</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">@@</MudText>
                                        <MudText Typo="Typo.h6">@game.HomeTeam</MudText>
                                    </div>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudGrid>
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.overline" Color="Color.Secondary">MONEYLINE</MudText>
                                        <div class="d-flex justify-space-between">
                                            <MudChip T="string" Color="@GetOddsColor(game.AwayMoneyline)" Size="Size.Small">
                                                @game.AwayTeam: @FormatOdds(game.AwayMoneyline)
                                            </MudChip>
                                            <MudChip T="string" Color="@GetOddsColor(game.HomeMoneyline)" Size="Size.Small">
                                                @game.HomeTeam: @FormatOdds(game.HomeMoneyline)
                                            </MudChip>
                                        </div>
                                    </MudItem>
                                    @if (game.Spread.HasValue)
                                    {
                                        <MudItem xs="6">
                                            <MudText Typo="Typo.overline" Color="Color.Secondary">SPREAD</MudText>
                                            <MudText Typo="Typo.body1">@FormatSpread(game.Spread.Value)</MudText>
                                        </MudItem>
                                    }
                                    @if (game.OverUnder.HasValue)
                                    {
                                        <MudItem xs="6">
                                            <MudText Typo="Typo.overline" Color="Color.Secondary">O/U</MudText>
                                            <MudText Typo="Typo.body1">@game.OverUnder.Value</MudText>
                                        </MudItem>
                                    }
                                </MudGrid>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
        else if (!_isLoading)
        {
            <MudAlert Severity="Severity.Info">
                No NFL games scheduled for today. Check back on game days!
            </MudAlert>
        }

        <!-- Kelly Calculator -->
        <MudExpansionPanels>
            <MudExpansionPanel Text="Kelly Criterion Calculator" Icon="@Icons.Material.Filled.Calculate">
                <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
                    <strong>How to use:</strong> The Kelly Criterion calculates optimal bet sizing based on your edge.
                    <ol class="mt-2 mb-0" style="padding-left: 20px;">
                        <li><strong>Win Probability</strong> - Your estimated chance the bet wins (0.55 = 55%)</li>
                        <li><strong>American Odds</strong> - The sportsbook line (e.g., -110 or +150)</li>
                        <li><strong>Bankroll</strong> - Your total betting budget</li>
                    </ol>
                </MudAlert>
                <MudGrid>
                    <MudItem xs="12" md="3">
                        <MudNumericField @bind-Value="_kellyWinProb" Label="Win Probability" 
                                        Min="0" Max="1" Step="0.01" HelperText="0.55 = 55%"
                                        Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudNumericField @bind-Value="_kellyOdds" Label="American Odds"
                                        HelperText="-110 or +150" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudNumericField @bind-Value="_kellyBankroll" Label="Bankroll"
                                        Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                                        Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="3" Class="d-flex align-end">
                        <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="CalculateKelly">
                            Calculate
                        </MudButton>
                    </MudItem>
                </MudGrid>
                
                @if (_kellyResult != null)
                {
                    <MudPaper Class="pa-4 mt-3" Elevation="1" Style="background: var(--mud-palette-background-default);">
                        <MudGrid>
                            <MudItem xs="6" md="3">
                                <MudText Typo="Typo.overline" Color="Color.Secondary">IMPLIED PROB</MudText>
                                <MudText Typo="Typo.h6">@(_kellyResult.ImpliedProbability)%</MudText>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudText Typo="Typo.overline" Color="Color.Secondary">MODEL EDGE</MudText>
                                <MudText Typo="Typo.h6" Color="@(_kellyResult.ModelEdge > 0 ? Color.Success : Color.Error)">
                                    @(_kellyResult.ModelEdge > 0 ? "+" : "")@(_kellyResult.ModelEdge)%
                                </MudText>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudText Typo="Typo.overline" Color="Color.Secondary">RECOMMENDED BET</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Primary">$@(_kellyResult.RecommendedBet)</MudText>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudText Typo="Typo.overline" Color="Color.Secondary">% OF BANKROLL</MudText>
                                <MudText Typo="Typo.h6">@(_kellyResult.BetPercentage)%</MudText>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                }
            </MudExpansionPanel>
        </MudExpansionPanels>
    </MudStack>
</MudContainer>

@code {
    private bool _isLoading = false;
    private bool _isAnalyzing = false;
    private string _errorMessage = "";
    private string _selectedSportsbook = "fanduel";
    private List<string> _sportsbooks = new() { "fanduel", "draftkings", "betmgm", "pointsbet", "caesars" };
    private List<GameOdds> _games = new();
    private List<AnalyzedGame> _analyzedGames = new();
    
    // Kelly Calculator
    private double _kellyWinProb = 0.55;
    private int _kellyOdds = -110;
    private double _kellyBankroll = 1000;
    private KellyResult? _kellyResult;

    protected override async Task OnInitializedAsync()
    {
        await RefreshOdds();
    }

    private async Task RefreshOdds()
    {
        _isLoading = true;
        _errorMessage = "";
        _analyzedGames = new();
        StateHasChanged();
        
        try
        {
            var response = await Http.GetFromJsonAsync<OddsResponse>(
                $"http://backend:8000/odds/nfl?sportsbook={_selectedSportsbook}");
            
            if (response?.Error != null)
            {
                _errorMessage = response.Error;
                _games = new();
            }
            else if (response?.Games != null)
            {
                _games = response.Games;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to fetch odds: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task RunAnalysis()
    {
        _isAnalyzing = true;
        StateHasChanged();
        
        try
        {
            var response = await Http.PostAsync(
                $"http://backend:8000/odds/nfl/analyze-all?sportsbook={_selectedSportsbook}", null);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<AnalysisResponse>();
                if (result?.Games != null)
                {
                    _analyzedGames = result.Games;
                    var valueBets = _analyzedGames.Count(g => g.HasValue);
                    Snackbar.Add($"Analysis complete! {valueBets} value bet(s) found.", 
                        valueBets > 0 ? Severity.Success : Severity.Info);
                }
            }
            else
            {
                Snackbar.Add("Analysis failed", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isAnalyzing = false;
        }
    }

    private async Task CalculateKelly()
    {
        try
        {
            var url = $"http://backend:8000/odds/nba/calculate-kelly?win_probability={_kellyWinProb}&american_odds={_kellyOdds}&bankroll={_kellyBankroll}";
            _kellyResult = await Http.GetFromJsonAsync<KellyResult>(url);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private string FormatBookName(string book) => book switch
    {
        "fanduel" => "FanDuel",
        "draftkings" => "DraftKings",
        "betmgm" => "BetMGM",
        "pointsbet" => "PointsBet",
        "caesars" => "Caesars",
        _ => book
    };

    private string FormatOdds(int? odds)
    {
        if (!odds.HasValue) return "N/A";
        return odds.Value > 0 ? $"+{odds.Value}" : odds.Value.ToString();
    }

    private string FormatSpread(double spread)
    {
        return spread > 0 ? $"+{spread}" : spread.ToString();
    }

    private Color GetOddsColor(int? odds)
    {
        if (!odds.HasValue) return Color.Default;
        return odds.Value < 0 ? Color.Warning : Color.Success;
    }

    // Models
    public class OddsResponse
    {
        [System.Text.Json.Serialization.JsonPropertyName("date")] public string? Date { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("sportsbook")] public string? Sportsbook { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("games")] public List<GameOdds> Games { get; set; } = new();
        [System.Text.Json.Serialization.JsonPropertyName("error")] public string? Error { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("message")] public string? Message { get; set; }
    }
    
    public class GameOdds
    {
        [System.Text.Json.Serialization.JsonPropertyName("home_team")] public string HomeTeam { get; set; } = "";
        [System.Text.Json.Serialization.JsonPropertyName("away_team")] public string AwayTeam { get; set; } = "";
        [System.Text.Json.Serialization.JsonPropertyName("home_moneyline")] public int? HomeMoneyline { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("away_moneyline")] public int? AwayMoneyline { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("spread")] public double? Spread { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("over_under")] public double? OverUnder { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("status")] public string Status { get; set; } = "scheduled";
    }
    
    public class AnalysisResponse
    {
        [System.Text.Json.Serialization.JsonPropertyName("games")] public List<AnalyzedGame> Games { get; set; } = new();
        [System.Text.Json.Serialization.JsonPropertyName("value_bets_found")] public int ValueBetsFound { get; set; }
    }
    
    public class AnalyzedGame
    {
        [System.Text.Json.Serialization.JsonPropertyName("home_team")] public string HomeTeam { get; set; } = "";
        [System.Text.Json.Serialization.JsonPropertyName("away_team")] public string AwayTeam { get; set; } = "";
        [System.Text.Json.Serialization.JsonPropertyName("home_moneyline")] public int? HomeMoneyline { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("away_moneyline")] public int? AwayMoneyline { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("spread")] public double? Spread { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("over_under")] public double? OverUnder { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("predicted_winner")] public string? PredictedWinner { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("home_win_probability")] public double? HomeWinProbability { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("away_win_probability")] public double? AwayWinProbability { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("predicted_margin")] public double? PredictedMargin { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("predicted_total")] public double? PredictedTotal { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("confidence_level")] public string? ConfidenceLevel { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("ml_pick")] public string? MlPick { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("ml_value")] public bool MlValue { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("home_ml_edge")] public double? HomeMlEdge { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("spread_pick")] public string? SpreadPick { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("spread_value")] public bool SpreadValue { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("spread_edge")] public double? SpreadEdge { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("ou_pick")] public string? OuPick { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("ou_value")] public bool OuValue { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("ou_edge")] public double? OuEdge { get; set; }
        
        [System.Text.Json.Serialization.JsonPropertyName("has_value")] public bool HasValue { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("value_bets")] public List<string> ValueBets { get; set; } = new();
    }
    
    public class KellyResult
    {
        [System.Text.Json.Serialization.JsonPropertyName("implied_probability")] public double ImpliedProbability { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("model_edge")] public double ModelEdge { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("recommended_bet")] public double RecommendedBet { get; set; }
        [System.Text.Json.Serialization.JsonPropertyName("bet_percentage")] public double BetPercentage { get; set; }
    }
}
